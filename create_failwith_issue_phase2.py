#!/usr/bin/env python3
"""
åˆ›å»º failwith è¿ç§»ç¬¬äºŒé˜¶æ®µçš„ GitHub Issue
ç»§ç»­æ¨è¿› failwith åˆ°ç»Ÿä¸€é”™è¯¯å¤„ç†ç³»ç»Ÿçš„è¿ç§»
"""

import requests
import json
from github_auth import get_installation_token

def create_failwith_migration_issue():
    """åˆ›å»º failwith è¿ç§»ç¬¬äºŒé˜¶æ®µçš„ issue"""
    
    token = get_installation_token()
    
    headers = {
        'Authorization': f'token {token}',
        'Accept': 'application/vnd.github+json'
    }
    
    issue_title = "æŠ€æœ¯å€ºåŠ¡æ”¹è¿›ï¼šç»§ç»­æ¨è¿› failwith åˆ°ç»Ÿä¸€é”™è¯¯å¤„ç†ç³»ç»Ÿçš„è¿ç§» - ç¬¬äºŒé˜¶æ®µ"
    
    issue_body = """## æ¦‚è¿°

ç»§ç»­æ¨è¿› failwith é”™è¯¯å¤„ç†åˆ°ç»Ÿä¸€é”™è¯¯å¤„ç†ç³»ç»Ÿçš„è¿ç§»ï¼Œæå‡ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œé”™è¯¯å¤„ç†çš„ä¸€è‡´æ€§ã€‚è¿™æ˜¯ç»§ Issue #736 å’Œ PR #737 ä¹‹åçš„ç¬¬äºŒé˜¶æ®µæ”¹è¿›ã€‚

## èƒŒæ™¯

ç¬¬ä¸€é˜¶æ®µï¼ˆ#736, #737ï¼‰å·²ç»å®Œæˆäº†æ ¸å¿ƒæ¨¡å—ä¸­çš„ failwith é”™è¯¯æ¶ˆæ¯æ ¼å¼ç»Ÿä¸€åŒ–ã€‚ç°åœ¨éœ€è¦ç»§ç»­æ¨è¿›ï¼Œå°†æ›´å¤šçš„ failwith è°ƒç”¨è¿ç§»åˆ° `unified_errors.ml` çš„ç»Ÿä¸€é”™è¯¯å¤„ç†ç³»ç»Ÿã€‚

## éœ€è¦å¤„ç†çš„ failwith è°ƒç”¨

æ ¹æ®æœ€æ–°çš„ä»£ç åˆ†æï¼Œå‘ç°äº†ä»¥ä¸‹éœ€è¦æ”¹è¿›çš„ failwith ä½¿ç”¨ï¼š

### ğŸ“‹ æ ¸å¿ƒæ¨¡å—ä¸­çš„ failwithï¼ˆ51å¤„ï¼‰

#### æµ‹è¯•æ–‡ä»¶ä¸­çš„æ”¹è¿›ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ç­‰ï¼‰
- **test/test_*.ml** - æµ‹è¯•é”™è¯¯å¤„ç†å¯ä»¥ä¿æŒç°çŠ¶ï¼Œä½†å»ºè®®æ ‡å‡†åŒ–é”™è¯¯æ¶ˆæ¯æ ¼å¼

#### æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰
1. **è¯æ³•åˆ†æå™¨ç›¸å…³**
   - `src/lexer_*.ml` - è¯æ³•é”™è¯¯åº”ä½¿ç”¨ç»Ÿä¸€æ ¼å¼
   - `src/unicode/` - Unicodeå¤„ç†é”™è¯¯

2. **è§£æå™¨ç›¸å…³**  
   - `src/parser_*.ml` - è¯­æ³•è§£æé”™è¯¯
   - `src/ast_*.ml` - ASTæ„å»ºé”™è¯¯

3. **ä»£ç ç”Ÿæˆå™¨**
   - `src/codegen_*.ml` - ä»£ç ç”Ÿæˆé”™è¯¯
   - `src/runtime_*.ml` - è¿è¡Œæ—¶é”™è¯¯

4. **è¯—è¯åˆ†ææ¨¡å—**
   - `src/poetry/` - è¯—è¯æ ¼å¼éªŒè¯é”™è¯¯
   - `src/refactoring_analyzer_*.ml` - é‡æ„åˆ†æé”™è¯¯

## æ”¹è¿›ç­–ç•¥

### ğŸ¯ ç¬¬äºŒé˜¶æ®µç›®æ ‡
1. **é”™è¯¯åˆ†ç±»æ ‡å‡†åŒ–**: å»ºç«‹æ˜ç¡®çš„é”™è¯¯ç±»å‹åˆ†ç±»ä½“ç³»
2. **é€æ­¥è¿ç§»**: ä¼˜å…ˆå¤„ç†æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
3. **å‘åå…¼å®¹**: ç¡®ä¿ä¸ç ´åç°æœ‰åŠŸèƒ½
4. **æµ‹è¯•è¦†ç›–**: ç¡®ä¿é”™è¯¯å¤„ç†çš„æµ‹è¯•è¦†ç›–ç‡

### ğŸ“ å…·ä½“å®æ–½æ­¥éª¤

#### é˜¶æ®µ 2.1ï¼šé”™è¯¯åˆ†ç±»ä½“ç³»å®Œå–„
- [ ] å®Œå–„ `unified_errors.ml` çš„é”™è¯¯ç±»å‹å®šä¹‰
- [ ] æ·»åŠ æ›´å…·ä½“çš„é”™è¯¯å­ç±»å‹
- [ ] æ ‡å‡†åŒ–é”™è¯¯æ¶ˆæ¯æ ¼å¼

#### é˜¶æ®µ 2.2ï¼šæ ¸å¿ƒæ¨¡å—è¿ç§»
- [ ] **è¯æ³•åˆ†æå™¨æ¨¡å—** (`src/lexer_*.ml`)
  - è¿ç§»å­—ç¬¦å¤„ç†é”™è¯¯
  - è¿ç§»Tokenè§£æé”™è¯¯
  - ç»Ÿä¸€Unicodeé”™è¯¯å¤„ç†
  
- [ ] **è§£æå™¨æ¨¡å—** (`src/parser_*.ml`)
  - è¿ç§»è¯­æ³•è§£æé”™è¯¯
  - è¿ç§»è¡¨è¾¾å¼è§£æé”™è¯¯
  - ç»Ÿä¸€ASTæ„å»ºé”™è¯¯

- [ ] **ä»£ç ç”Ÿæˆæ¨¡å—** (`src/codegen_*.ml`)
  - è¿ç§»ç±»å‹è½¬æ¢é”™è¯¯
  - è¿ç§»ä»£ç ç”Ÿæˆé”™è¯¯
  - ç»Ÿä¸€è¿è¡Œæ—¶é”™è¯¯

#### é˜¶æ®µ 2.3ï¼šä¸“ä¸šæ¨¡å—è¿ç§»
- [ ] **è¯—è¯åˆ†ææ¨¡å—** (`src/poetry/`)
  - è¿ç§»æ ¼å¼éªŒè¯é”™è¯¯  
  - è¿ç§»éŸµå¾‹åˆ†æé”™è¯¯
  - ç»Ÿä¸€è‰ºæœ¯æ€§è¯„ä»·é”™è¯¯

- [ ] **é‡æ„åˆ†ææ¨¡å—** (`src/refactoring_analyzer_*.ml`)
  - è¿ç§»ä»£ç åˆ†æé”™è¯¯
  - è¿ç§»é‡æ„å»ºè®®é”™è¯¯

### ğŸ”§ æŠ€æœ¯å®æ–½æ–¹æ¡ˆ

#### é”™è¯¯ç±»å‹æ‰©å±•
```ocaml
(* unified_errors.ml æ‰©å±• *)
type error_category = 
  | LexicalError of lexical_error_type
  | ParseError of parse_error_type  
  | RuntimeError of runtime_error_type
  | PoetryError of poetry_error_type
  | SystemError of system_error_type
  | InternalError of internal_error_type

type lexical_error_type =
  | InvalidCharacter of string
  | UnterminatedString 
  | InvalidNumber of string
  | UnicodeError of string

type parse_error_type =
  | SyntaxError of string
  | UnexpectedToken of string
  | MissingExpression
  | InvalidExpression of string
```

#### è¿ç§»æ¨¡å¼
```ocaml
(* æ”¹è¿›å‰ *)
failwith "Invalid character"

(* æ”¹è¿›å *)
Error (UnifiedError.create 
  ~category:(LexicalError (InvalidCharacter char))
  ~message:"è¯æ³•é”™è¯¯ï¼šæ— æ•ˆå­—ç¬¦"
  ~location:pos
  ~suggestion:"è¯·ä½¿ç”¨æ”¯æŒçš„ä¸­æ–‡å­—ç¬¦"
)
```

## éªŒè¯æ ‡å‡†

### âœ… æˆåŠŸæ ‡å‡†
1. **åŠŸèƒ½å®Œæ•´æ€§**: æ‰€æœ‰ç°æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
2. **é”™è¯¯ä¸€è‡´æ€§**: é”™è¯¯æ¶ˆæ¯æ ¼å¼ç»Ÿä¸€ä¸”æ¸…æ™°
3. **æµ‹è¯•é€šè¿‡**: æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡
4. **æ€§èƒ½ä¿æŒ**: é”™è¯¯å¤„ç†ä¸å½±å“æ€§èƒ½
5. **å‘åå…¼å®¹**: ä¸ç ´åç°æœ‰API

### ğŸ§ª æµ‹è¯•è¦æ±‚
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰æ–°çš„é”™è¯¯ç±»å‹
- [ ] é›†æˆæµ‹è¯•éªŒè¯é”™è¯¯ä¼ æ’­
- [ ] æ€§èƒ½æµ‹è¯•ç¡®ä¿æ— regression
- [ ] ç”¨æˆ·ä½“éªŒæµ‹è¯•éªŒè¯é”™è¯¯æ¶ˆæ¯è´¨é‡

## é£é™©è¯„ä¼°

### ğŸŸ¡ ä¸­ç­‰é£é™©å› ç´ 
- **ä»£ç é‡å¤§**: æ¶‰åŠå¤šä¸ªæ ¸å¿ƒæ¨¡å—
- **æµ‹è¯•è¦†ç›–**: éœ€è¦ç¡®ä¿å…¨é¢çš„æµ‹è¯•è¦†ç›–
- **å…¼å®¹æ€§**: ç¡®ä¿ä¸ç ´åç°æœ‰åŠŸèƒ½

### ğŸ›¡ï¸ é£é™©ç¼“è§£æªæ–½
- **åˆ†é˜¶æ®µå®æ–½**: é€æ¨¡å—è¿ç§»ï¼Œé™ä½é£é™©
- **å……åˆ†æµ‹è¯•**: æ¯ä¸ªæ¨¡å—è¿ç§»åéƒ½è¦å……åˆ†æµ‹è¯•
- **ä»£ç å®¡æŸ¥**: ç¡®ä¿ä»£ç è´¨é‡å’Œä¸€è‡´æ€§
- **å›æ»šè®¡åˆ’**: å¦‚æœ‰é—®é¢˜å¯å¿«é€Ÿå›æ»š

## é¢„æœŸæ”¶ç›Š

### ğŸš€ ç›´æ¥æ”¶ç›Š
- **ç»Ÿä¸€ä½“éªŒ**: ç”¨æˆ·è·å¾—ä¸€è‡´çš„é”™è¯¯å¤„ç†ä½“éªŒ
- **æ›´å¥½è°ƒè¯•**: å¼€å‘è€…æ›´å®¹æ˜“å®šä½å’Œä¿®å¤é—®é¢˜
- **ä»£ç è´¨é‡**: æå‡æ•´ä½“ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§
- **ç³»ç»Ÿç¨³å®š**: æ›´å¥å£®çš„é”™è¯¯å¤„ç†æœºåˆ¶

### ğŸ“ˆ é•¿æœŸä»·å€¼
- **æŠ€æœ¯å€ºåŠ¡**: æ˜¾è‘—å‡å°‘æŠ€æœ¯å€ºåŠ¡
- **å¼€å‘æ•ˆç‡**: æå‡åç»­å¼€å‘å’Œç»´æŠ¤æ•ˆç‡
- **ç”¨æˆ·æ»¡æ„**: æå‡ç”¨æˆ·ä½¿ç”¨ä½“éªŒ
- **é¡¹ç›®å½¢è±¡**: å±•ç°é¡¹ç›®çš„ä¸“ä¸šæ€§å’Œå®Œæ•´æ€§

## å®æ–½æ—¶é—´è¡¨

### ğŸ—“ï¸ é¢„è®¡æ—¶é—´çº¿
- **é˜¶æ®µ2.1** (é”™è¯¯åˆ†ç±»å®Œå–„): 1-2å¤©
- **é˜¶æ®µ2.2** (æ ¸å¿ƒæ¨¡å—è¿ç§»): 3-5å¤©  
- **é˜¶æ®µ2.3** (ä¸“ä¸šæ¨¡å—è¿ç§»): 2-3å¤©
- **æµ‹è¯•å’Œä¼˜åŒ–**: 1-2å¤©

**æ€»è®¡**: çº¦ 7-12å¤©

## ç›¸å…³èµ„æº

- **ç¬¬ä¸€é˜¶æ®µ**: Issue #736, PR #737
- **ç»Ÿä¸€é”™è¯¯å¤„ç†**: `src/unified_errors.ml`
- **é”™è¯¯å¤„ç†æ–‡æ¡£**: `doc/design/error-handling.md`
- **æµ‹è¯•æŒ‡å—**: `doc/testing/error-handling-tests.md`

---

**ç±»å‹**: ğŸ”§ æŠ€æœ¯å€ºåŠ¡æ”¹è¿›  
**ä¼˜å…ˆçº§**: é«˜  
**é¢„æœŸå·¥ä½œé‡**: ä¸­ç­‰  
**å½±å“èŒƒå›´**: æ ¸å¿ƒåŠŸèƒ½æ¨¡å—  
**ç›¸å…³æ¨¡å—**: è¯æ³•åˆ†æå™¨ã€è§£æå™¨ã€ä»£ç ç”Ÿæˆå™¨ã€è¯—è¯åˆ†æ  

**æ ‡ç­¾**: `æŠ€æœ¯å€ºåŠ¡`, `é”™è¯¯å¤„ç†`, `ä»£ç è´¨é‡`, `é‡æ„`, `ç»Ÿä¸€åŒ–`
"""

    data = {
        'title': issue_title,
        'body': issue_body,
        'labels': ['æŠ€æœ¯å€ºåŠ¡', 'é”™è¯¯å¤„ç†', 'ä»£ç è´¨é‡', 'é‡æ„']
    }
    
    url = 'https://api.github.com/repos/UltimatePea/chinese-ocaml/issues'
    
    response = requests.post(url, headers=headers, json=data)
    
    if response.status_code == 201:
        issue = response.json()
        print(f"âœ… Issue åˆ›å»ºæˆåŠŸ!")
        print(f"Issue #{issue['number']}: {issue['title']}")
        print(f"URL: {issue['html_url']}")
        return issue['number']
    else:
        print(f"âŒ Issue åˆ›å»ºå¤±è´¥:")
        print(f"çŠ¶æ€ç : {response.status_code}")
        print(f"å“åº”: {response.text}")
        return None

if __name__ == '__main__':
    create_failwith_migration_issue()