open Yyocamlc_lib.Lexer
open Yyocamlc_lib.Parser
open Yyocamlc_lib.Ast

(** è‡ªç„¶è¯­è¨€å‡½æ•°å®šä¹‰ç³»ç»Ÿç»¼åˆæµ‹è¯•å¥—ä»¶ *)

let test_count = ref 0
let passed_count = ref 0

let test_execution test_name test_code expected_output =
  incr test_count;
  Printf.printf "ğŸ§ª æµ‹è¯• %d: %s\n" !test_count test_name;
  try
    let tokens = tokenize test_code "test.ly" in
    let state = create_parser_state tokens in
    let (ast, _) = parse_statement state in
    let result = match ast with
      | LetStmt (name, _) -> Printf.sprintf "å‡½æ•° %s å®šä¹‰æˆåŠŸ" name
      | _ -> "å…¶ä»–è¯­å¥"
    in
    if result = expected_output then (
      Printf.printf "âœ“ é€šè¿‡\n";
      incr passed_count
    ) else (
      Printf.printf "âœ— å¤±è´¥ - é¢„æœŸ: %s, å®é™…: %s\n" expected_output result
    )
  with
  | e -> Printf.printf "âœ— å¼‚å¸¸: %s\n" (Printexc.to_string e)

let test_error test_name test_code =
  incr test_count;
  Printf.printf "ğŸ§ª æµ‹è¯• %d: %s\n" !test_count test_name;
  try
    let tokens = tokenize test_code "test.ly" in
    let state = create_parser_state tokens in
    let (_ast, _) = parse_statement state in
    Printf.printf "âœ— åº”è¯¥æŠ›å‡ºé”™è¯¯\n"
  with
  | _ -> Printf.printf "âœ“ æ­£ç¡®å¤„ç†é”™è¯¯\n"; incr passed_count

let run_all_tests () =
  Printf.printf "ğŸ§ª è‡ªç„¶è¯­è¨€å‡½æ•°å®šä¹‰ç³»ç»Ÿç»¼åˆæµ‹è¯•å¥—ä»¶\n";
  Printf.printf "====================================\n";

  Printf.printf "\n=== åŸºç¡€åŠŸèƒ½æµ‹è¯• ===\n";

  (* æµ‹è¯•1: ç®€å•è‡ªç„¶è¯­è¨€å‡½æ•°å®šä¹‰ *)
  test_execution "ç®€å•å‡½æ•°å®šä¹‰"
    "å®šä¹‰ã€ŒåŠ ä¸€ã€æ¥å—ã€Œæ•°å­—ã€ï¼šæ•°å­—åŠ ä¸Šã€Œ1ã€"
    "å‡½æ•° åŠ ä¸€ å®šä¹‰æˆåŠŸ";

  (* æµ‹è¯•2: æ¡ä»¶å‡½æ•° *)
  test_execution "æ¡ä»¶å‡½æ•°å®šä¹‰"
    "å®šä¹‰ã€Œæ˜¯å¦æ­£æ•°ã€æ¥å—ã€Œå€¼ã€ï¼šå½“ã€Œå€¼ã€å°äºç­‰äºã€Œ0ã€æ—¶è¿”å›ã€Œå‡ã€å¦åˆ™è¿”å›ã€ŒçœŸã€"
    "å‡½æ•° æ˜¯å¦æ­£æ•° å®šä¹‰æˆåŠŸ";

  (* æµ‹è¯•3: é€’å½’å‡½æ•° *)
  test_execution "é€’å½’å‡½æ•°å®šä¹‰"
    "å®šä¹‰ã€Œé˜¶ä¹˜ã€æ¥å—ã€Œnã€ï¼šå½“ã€Œnã€å°äºç­‰äºã€Œ1ã€æ—¶è¿”å›ã€Œ1ã€å¦åˆ™è¿”å›ã€Œnã€ä¹˜ä»¥ã€Œnå‡ä¸€ã€ä¹‹ã€Œé˜¶ä¹˜ã€"
    "å‡½æ•° é˜¶ä¹˜ å®šä¹‰æˆåŠŸ";

  Printf.printf "\n=== è‡ªç„¶è¯­è¨€æ¨¡å¼æµ‹è¯• ===\n";

  (* æµ‹è¯•4: å‡ä¸€æ¨¡å¼ *)
  test_execution "å‡ä¸€æ¨¡å¼"
    "å®šä¹‰ã€Œå‰é©±ã€æ¥å—ã€Œæ•°ã€ï¼šæ•°å‡ä¸€"
    "å‡½æ•° å‰é©± å®šä¹‰æˆåŠŸ";

  (* æµ‹è¯•5: è¾“å…¥æ¨¡å¼ *)
  test_execution "è¾“å…¥æ¨¡å¼"
    "å®šä¹‰ã€Œå¤„ç†è¾“å…¥ã€æ¥å—ã€Œè¾“å…¥ã€ï¼šè¾“å…¥å‡ä¸€"
    "å‡½æ•° å¤„ç†è¾“å…¥ å®šä¹‰æˆåŠŸ";

  (* æµ‹è¯•6: ä¹˜æ³•æ¨¡å¼ *)
  test_execution "ä¹˜æ³•æ¨¡å¼"
    "å®šä¹‰ã€Œå¹³æ–¹ã€æ¥å—ã€Œxã€ï¼šxä¹˜ä»¥ã€Œxã€"
    "å‡½æ•° å¹³æ–¹ å®šä¹‰æˆåŠŸ";

  (* æµ‹è¯•7: åŠ æ³•æ¨¡å¼ *)
  test_execution "åŠ æ³•æ¨¡å¼"
    "å®šä¹‰ã€Œæ±‚å’Œã€æ¥å—ã€Œaã€ï¼šaåŠ ä¸Šã€Œ10ã€"
    "å‡½æ•° æ±‚å’Œ å®šä¹‰æˆåŠŸ";

  Printf.printf "\n=== å¤æ‚æ¡ä»¶æµ‹è¯• ===\n";

  (* æµ‹è¯•8: å¤šæ¡ä»¶å‡½æ•° *)
  test_execution "å¤šæ¡ä»¶å‡½æ•°"
    "å®šä¹‰ã€Œç»å¯¹å€¼ã€æ¥å—ã€Œæ•°å€¼ã€ï¼šå½“ã€Œæ•°å€¼ã€å°äºç­‰äºã€Œ0ã€æ—¶è¿”å›ã€Œ0ã€å‡å»ã€Œæ•°å€¼ã€å¦åˆ™è¿”å›ã€Œæ•°å€¼ã€"
    "å‡½æ•° ç»å¯¹å€¼ å®šä¹‰æˆåŠŸ";

  (* æµ‹è¯•9: åµŒå¥—æ¡ä»¶ *)
  test_execution "åµŒå¥—æ¡ä»¶"
    "å®šä¹‰ã€Œç¬¦å·ã€æ¥å—ã€Œxã€ï¼šå½“ã€Œxã€ä¸ºã€Œ0ã€æ—¶è¿”å›ã€Œ0ã€å¦åˆ™è¿”å›ã€Œ1ã€"
    "å‡½æ•° ç¬¦å· å®šä¹‰æˆåŠŸ";

  Printf.printf "\n=== é€’å½’æ¨¡å¼æµ‹è¯• ===\n";

  (* æµ‹è¯•10: æ–æ³¢é‚£å¥‘æ•°åˆ— *)
  test_execution "æ–æ³¢é‚£å¥‘æ•°åˆ—"
    "å®šä¹‰ã€Œæ–æ³¢é‚£å¥‘ã€æ¥å—ã€Œnã€ï¼šå½“ã€Œnã€å°äºç­‰äºã€Œ1ã€æ—¶è¿”å›ã€Œnã€å¦åˆ™è¿”å›ã€Œnå‡ä¸€ã€ä¹‹ã€Œæ–æ³¢é‚£å¥‘ã€åŠ ä¸Šã€Œnå‡ä¸€å‡ä¸€ã€ä¹‹ã€Œæ–æ³¢é‚£å¥‘ã€"
    "å‡½æ•° æ–æ³¢é‚£å¥‘ å®šä¹‰æˆåŠŸ";

  (* æµ‹è¯•11: å°¾é€’å½’é˜¶ä¹˜ *)
  test_execution "å°¾é€’å½’é˜¶ä¹˜"
    "å®šä¹‰ã€Œå°¾é€’å½’é˜¶ä¹˜ã€æ¥å—ã€Œnã€ï¼šå½“ã€Œnã€å°äºç­‰äºã€Œ1ã€æ—¶è¿”å›ã€Œ1ã€å¦åˆ™è¿”å›ã€Œnã€ä¹˜ä»¥ã€Œnå‡ä¸€ã€ä¹‹ã€Œå°¾é€’å½’é˜¶ä¹˜ã€"
    "å‡½æ•° å°¾é€’å½’é˜¶ä¹˜ å®šä¹‰æˆåŠŸ";

  Printf.printf "\n=== å‚æ•°ç»‘å®šæµ‹è¯• ===\n";

  (* æµ‹è¯•12: å‚æ•°é‡å‘½å *)
  test_execution "å‚æ•°é‡å‘½å"
    "å®šä¹‰ã€Œå¤„ç†æ•°æ®ã€æ¥å—ã€ŒåŸå§‹æ•°æ®ã€ï¼šåŸå§‹æ•°æ®åŠ ä¸Šã€Œ5ã€"
    "å‡½æ•° å¤„ç†æ•°æ® å®šä¹‰æˆåŠŸ";

  (* æµ‹è¯•13: é•¿å‚æ•°å *)
  test_execution "é•¿å‚æ•°å"
    "å®šä¹‰ã€Œè®¡ç®—ç»“æœã€æ¥å—ã€Œç”¨æˆ·è¾“å…¥çš„æ•°å­—ã€ï¼šç”¨æˆ·è¾“å…¥çš„æ•°å­—ä¹˜ä»¥ã€Œ2ã€"
    "å‡½æ•° è®¡ç®—ç»“æœ å®šä¹‰æˆåŠŸ";

  Printf.printf "\n=== ç±»å‹æ¨æ–­æµ‹è¯• ===\n";

  (* æµ‹è¯•14: æ•´æ•°ç±»å‹ *)
  test_execution "æ•´æ•°ç±»å‹æ¨æ–­"
    "å®šä¹‰ã€Œæ•´æ•°è®¡ç®—ã€æ¥å—ã€Œæ•°ã€ï¼šæ•°åŠ ä¸Šã€Œ42ã€"
    "å‡½æ•° æ•´æ•°è®¡ç®— å®šä¹‰æˆåŠŸ";

  (* æµ‹è¯•15: å¸ƒå°”ç±»å‹ *)
  test_execution "å¸ƒå°”ç±»å‹æ¨æ–­"
    "å®šä¹‰ã€Œæ¯”è¾ƒã€æ¥å—ã€Œaã€ï¼šå½“ã€Œaã€ä¸ºã€Œ0ã€æ—¶è¿”å›ã€ŒçœŸã€å¦åˆ™è¿”å›ã€Œå‡ã€"
    "å‡½æ•° æ¯”è¾ƒ å®šä¹‰æˆåŠŸ";

  Printf.printf "\n=== é”™è¯¯å¤„ç†æµ‹è¯• ===\n";

  (* æµ‹è¯•16: è¯­æ³•é”™è¯¯æ¢å¤ *)
  test_error "è¯­æ³•é”™è¯¯æ¢å¤" "å®šä¹‰ã€Œé”™è¯¯å‡½æ•°ã€æ¥å—";

  Printf.printf "\n=== å…¼å®¹æ€§æµ‹è¯• ===\n";

  (* æµ‹è¯•17: ä¸ä¼ ç»Ÿè¯­æ³•æ··ç”¨ *)
  test_execution "ä¼ ç»Ÿè¯­æ³•æ··ç”¨"
    "å®šä¹‰ã€Œæ–°å‡½æ•°ã€æ¥å—ã€Œè¾“å…¥ã€ï¼šè¾“å…¥åŠ ä¸Šã€Œ2ã€"
    "å‡½æ•° æ–°å‡½æ•° å®šä¹‰æˆåŠŸ";

  Printf.printf "\n=== æ€§èƒ½æµ‹è¯• ===\n";

  let start_time = Sys.time () in
  for i = 1 to 100 do
    let test_code = Printf.sprintf "å®šä¹‰ã€Œå‡½æ•°%dã€æ¥å—ã€Œå‚æ•°ã€ï¼šå‚æ•°åŠ ä¸Šã€Œ%dã€" i i in
    try
      let tokens = tokenize test_code "test.ly" in
      let state = create_parser_state tokens in
      let (_ast, _) = parse_statement state in
      ()
    with _ -> ()
  done;
  let end_time = Sys.time () in
  let duration = end_time -. start_time in

  incr test_count;
  Printf.printf "ğŸ§ª æµ‹è¯• %d: æ€§èƒ½åŸºå‡†æµ‹è¯•\n" !test_count;
  Printf.printf "âœ“ 100ä¸ªå‡½æ•°è§£æè€—æ—¶: %.4fç§’\n" duration;
  if duration < 1.0 then (
    Printf.printf "âœ“ æ€§èƒ½æµ‹è¯•é€šè¿‡ (< 1ç§’)\n";
    incr passed_count
  ) else (
    Printf.printf "âœ— æ€§èƒ½æµ‹è¯•å¤±è´¥ (>= 1ç§’)\n"
  );

  Printf.printf "\n=== è¾¹ç•Œæ¡ä»¶æµ‹è¯• ===\n";

  (* æµ‹è¯•19: ç©ºå‡½æ•°ä½“ *)
  test_error "ç©ºå‡½æ•°ä½“å¤„ç†" "å®šä¹‰ã€Œç©ºå‡½æ•°ã€æ¥å—ã€Œå‚æ•°ã€ï¼š";

  (* æµ‹è¯•20: é•¿å‡½æ•°å *)
  test_execution "é•¿å‡½æ•°åå¤„ç†"
    "å®šä¹‰ã€Œè¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„å‡½æ•°åç§°ç”¨æ¥æµ‹è¯•ç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›ã€æ¥å—ã€Œå‚æ•°ã€ï¼šå‚æ•°åŠ ä¸Šã€Œ1ã€"
    "å‡½æ•° è¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„å‡½æ•°åç§°ç”¨æ¥æµ‹è¯•ç³»ç»Ÿçš„å¤„ç†èƒ½åŠ› å®šä¹‰æˆåŠŸ";

  Printf.printf "\n=== é›†æˆæµ‹è¯• ===\n";

  (* æµ‹è¯•21: å¤åˆè‡ªç„¶è¯­è¨€è¡¨è¾¾å¼ *)
  test_execution "å¤åˆè¡¨è¾¾å¼"
    "å®šä¹‰ã€Œå¤æ‚è®¡ç®—ã€æ¥å—ã€Œè¾“å…¥ã€ï¼šå½“ã€Œè¾“å…¥ã€å°äºç­‰äºã€Œ0ã€æ—¶è¿”å›ã€Œè¾“å…¥ã€ä¹˜ä»¥ã€Œ-1ã€å¦åˆ™è¿”å›ã€Œè¾“å…¥ã€åŠ ä¸Šã€Œè¾“å…¥å‡ä¸€ã€ä¹‹ã€Œå¤æ‚è®¡ç®—ã€"
    "å‡½æ•° å¤æ‚è®¡ç®— å®šä¹‰æˆåŠŸ";

  (* æµ‹è¯•22: å¤šå‚æ•°æ”¯æŒæ‰©å±• *)
  test_execution "å¤šå‚æ•°å‡½æ•°ï¼ˆæ‰©å±•ï¼‰"
    "å®šä¹‰ã€Œä¸¤æ•°ç›¸åŠ ã€æ¥å—ã€Œç¬¬ä¸€ä¸ªæ•°ã€ï¼šç¬¬ä¸€ä¸ªæ•°åŠ ä¸Šã€Œ100ã€"
    "å‡½æ•° ä¸¤æ•°ç›¸åŠ  å®šä¹‰æˆåŠŸ";

  Printf.printf "\n=== æµ‹è¯•æ€»ç»“ ===\n";
  Printf.printf "æ€»æµ‹è¯•æ•°: %d\n" !test_count;
  Printf.printf "é€šè¿‡æµ‹è¯•: %d\n" !passed_count;
  Printf.printf "å¤±è´¥æµ‹è¯•: %d\n" (!test_count - !passed_count);
  Printf.printf "é€šè¿‡ç‡: %.1f%%\n" (100.0 *. (float_of_int !passed_count) /. (float_of_int !test_count));

  if !passed_count = !test_count then
    Printf.printf "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼è‡ªç„¶è¯­è¨€å‡½æ•°å®šä¹‰ç³»ç»Ÿå®æ–½æˆåŠŸï¼\n"
  else
    Printf.printf "âš ï¸  éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–\n"

let () = run_all_tests ()