#!/usr/bin/env python3
"""
åˆ›å»º failwith ç»Ÿä¸€é”™è¯¯å¤„ç†è¿ç§» PR
"""

import requests
from github_auth import get_installation_token

def create_pr():
    token = get_installation_token()
    
    headers = {
        'Authorization': f'token {token}',
        'Accept': 'application/vnd.github+json'
    }
    
    # PR æ ‡é¢˜å’Œå†…å®¹
    title = "æŠ€æœ¯å€ºåŠ¡æ”¹è¿›ï¼šä¼˜åŒ– failwith é”™è¯¯æ¶ˆæ¯æ ¼å¼ç»Ÿä¸€æ€§ Fix #736"
    
    body = """## æ¦‚è¿°

æœ¬ PR å®æ–½äº† Issue #736 ä¸­æè®®çš„ failwith é”™è¯¯æ¶ˆæ¯ç»Ÿä¸€åŒ–æ”¹è¿›ï¼Œæå‡äº†é”™è¯¯å¤„ç†çš„ä¸€è‡´æ€§å’Œç”¨æˆ·å‹å¥½æ€§ã€‚

## ä¿®æ”¹å†…å®¹

### ğŸ¯ ä¸»è¦æ”¹è¿›
- **ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯æ ¼å¼**: ä¸ºæ‰€æœ‰ failwith è°ƒç”¨æ·»åŠ äº†æ˜ç¡®çš„é”™è¯¯ç±»å‹å‰ç¼€
- **ä¸­æ–‡é”™è¯¯æ¶ˆæ¯**: å°†è‹±æ–‡é”™è¯¯æ¶ˆæ¯æ›¿æ¢ä¸ºä¸­æ–‡ï¼Œç¬¦åˆéª†è¨€è¯­è¨€çš„è®¾è®¡ç†å¿µ
- **é”™è¯¯åˆ†ç±»**: æŒ‰é”™è¯¯æ€§è´¨åˆ†ç±»ï¼Œä¾¿äºç”¨æˆ·ç†è§£å’Œè°ƒè¯•

### ğŸ“‹ é”™è¯¯ç±»å‹åˆ†ç±»
- **ç±»å‹é”™è¯¯**: ç±»å‹ç³»ç»Ÿç›¸å…³é”™è¯¯
- **è¯æ³•é”™è¯¯**: è¯æ³•åˆ†æé˜¶æ®µé”™è¯¯
- **è§£æé”™è¯¯**: æ•°æ®è§£æç›¸å…³é”™è¯¯
- **è¿è¡Œæ—¶é”™è¯¯**: ç¨‹åºè¿è¡Œæ—¶éªŒè¯é”™è¯¯
- **ç³»ç»Ÿé”™è¯¯**: ç³»ç»Ÿçº§æ“ä½œé”™è¯¯
- **ç¼–è¯‘å™¨é”™è¯¯**: ç¼–è¯‘å™¨å†…éƒ¨é”™è¯¯

### ğŸ“ ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨
- `src/poetry/parallelism_analysis.ml` - å¾‹è¯—æ ¼å¼éªŒè¯
- `src/poetry/rhyme_json_data_loader.ml` - JSONéŸµå¾‹æ•°æ®åŠ è½½
- `src/parser_expressions_utils.ml` - è¡¨è¾¾å¼è§£æå·¥å…·
- `src/lexer_parsers.ml` - è¯æ³•åˆ†æå™¨è§£æå™¨
- `src/parser_expressions_type_keywords.ml` - ç±»å‹å…³é”®å­—è§£æ
- `src/parser_ancient.ml` - å¤é›…ä½“è¯­æ³•è§£æ

## ç¤ºä¾‹å¯¹æ¯”

### æ”¹è¿›å‰ âŒ
```ocaml
failwith "Invalid rhyme category"
failwith "å¾‹è¯—å¿…é¡»æ˜¯å…«å¥"
failwith "ä¸æ˜¯ç±»å‹å…³é”®å­—"
failwith "æœªé—­åˆçš„å¼•ç”¨æ ‡è¯†ç¬¦"
```

### æ”¹è¿›å âœ…
```ocaml
failwith "è§£æé”™è¯¯ï¼šæ— æ•ˆçš„éŸµå¾‹ç±»åˆ«: ..."
failwith "è¿è¡Œæ—¶é”™è¯¯ï¼šå¾‹è¯—å¿…é¡»æ˜¯å…«å¥"
failwith "ç±»å‹é”™è¯¯ï¼šä¸æ˜¯ç±»å‹å…³é”®å­—"
failwith "è¯æ³•é”™è¯¯ï¼šæœªé—­åˆçš„å¼•ç”¨æ ‡è¯†ç¬¦"
```

## éªŒè¯ç»“æœ

- âœ… **æ„å»ºæµ‹è¯•**: `dune build` é€šè¿‡
- âœ… **å•å…ƒæµ‹è¯•**: `dune runtest` æ­£å¸¸è¿è¡Œ
- âœ… **é”™è¯¯æ ¼å¼**: æ¶ˆæ¯æ ¼å¼ä¿æŒä¸€è‡´
- âœ… **å‘åå…¼å®¹**: ä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… **é”™è¯¯æ•°é‡**: ä»åŸæ¥çš„ç®€å• failwith ä¼˜åŒ–ä¸º 6 ä¸ªæ ¼å¼åŒ–çš„é”™è¯¯è°ƒç”¨

## æŠ€æœ¯å€ºåŠ¡å½±å“

### ç›´æ¥æ•ˆç›Š
- ğŸ¯ **æå‡ç”¨æˆ·ä½“éªŒ**: é”™è¯¯æ¶ˆæ¯æ›´åŠ æ¸…æ™°å’Œå‹å¥½
- ğŸ”§ **ä¾¿äºè°ƒè¯•**: é”™è¯¯ç±»å‹åˆ†ç±»æ˜ç¡®ï¼Œä¾¿äºå¿«é€Ÿå®šä½é—®é¢˜
- ğŸ“– **ä¸­æ–‡åŒ–æ”¯æŒ**: ç¬¦åˆéª†è¨€è¯­è¨€çš„ä¸­æ–‡ç¼–ç¨‹ç†å¿µ
- ğŸ—ï¸ **ä»£ç è´¨é‡**: é”™è¯¯å¤„ç†æ›´åŠ è§„èŒƒå’Œä¸€è‡´

### åç»­æ”¹è¿›
è¿™æ¬¡æ”¹è¿›ä¸ºåç»­å®Œæ•´è¿ç§»åˆ°ç»Ÿä¸€é”™è¯¯å¤„ç†ç³»ç»Ÿ (`unified_errors.ml`) å¥ å®šäº†åŸºç¡€ï¼š
- é”™è¯¯æ¶ˆæ¯å·²æ ‡å‡†åŒ–
- é”™è¯¯åˆ†ç±»å·²ç¡®ç«‹
- å¯é€æ­¥æ›¿æ¢ä¸º Result ç±»å‹

## é£é™©è¯„ä¼°

**ğŸŸ¢ ä½é£é™©æ”¹è¿›**
- åªä¿®æ”¹äº†é”™è¯¯æ¶ˆæ¯æ–‡æœ¬ï¼Œæœªæ”¹å˜ç¨‹åºé€»è¾‘
- ä¿æŒäº†åŸæœ‰çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- æ‰€æœ‰æµ‹è¯•æ­£å¸¸é€šè¿‡

## ç›¸å…³ Issue

Fix #736 - æŠ€æœ¯å€ºåŠ¡æ”¹è¿›ï¼šç»§ç»­æ¨è¿› failwith åˆ°ç»Ÿä¸€é”™è¯¯å¤„ç†ç³»ç»Ÿçš„è¿ç§»

---

**ç±»å‹**: ğŸ”§ æŠ€æœ¯å€ºåŠ¡ä¿®å¤  
**ä¼˜å…ˆçº§**: ä¸­ç­‰  
**å½±å“èŒƒå›´**: é”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒ  
**å‘åå…¼å®¹**: âœ… å®Œå…¨å…¼å®¹

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)"""
    
    # åˆ›å»º PR
    url = 'https://api.github.com/repos/UltimatePea/chinese-ocaml/pulls'
    
    pr_data = {
        'title': title,
        'body': body,
        'head': 'fix-736-failwith-migration',
        'base': 'main',
        'draft': False
    }
    
    response = requests.post(url, headers=headers, json=pr_data)
    
    if response.status_code == 201:
        pr = response.json()
        print(f"âœ… PR åˆ›å»ºæˆåŠŸ!")
        print(f"PR #{pr['number']}: {pr['title']}")
        print(f"URL: {pr['html_url']}")
        return pr['number']
    else:
        print(f"âŒ PR åˆ›å»ºå¤±è´¥:")
        print(f"çŠ¶æ€ç : {response.status_code}")
        print(f"å“åº”: {response.text}")
        return None

if __name__ == '__main__':
    pr_number = create_pr()
    if pr_number:
        print(f"\nâœ¨ PR #{pr_number} å·²åˆ›å»ºï¼Œè§£å†³äº† Issue #736!")
        print("ç­‰å¾…é¡¹ç›®ç»´æŠ¤è€…å®¡æŸ¥å’Œåˆå¹¶ã€‚")