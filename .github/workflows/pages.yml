# éª†è¨€åœ¨çº¿IDE GitHub Pageséƒ¨ç½²å·¥ä½œæµ
name: éƒ¨ç½²éª†è¨€åœ¨çº¿IDEåˆ°Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# è®¾ç½®æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# å¹¶å‘æ§åˆ¶
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æ„å»ºä½œä¸š
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ğŸ”§ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ“Š ç”Ÿæˆæ–‡ä»¶æ¸…å•
        run: |
          cd web-ide
          echo "ğŸ” æ‰«æé¡¹ç›®æ–‡ä»¶..."
          node generate-manifest.js
          echo "âœ… æ–‡ä»¶æ¸…å•ç”Ÿæˆå®Œæˆ"
          
      - name: ğŸ“ å‡†å¤‡éƒ¨ç½²æ–‡ä»¶
        run: |
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p _site/web-ide
          
          # å¤åˆ¶IDEæ–‡ä»¶
          cp -r web-ide/* _site/web-ide/
          
          # åˆ›å»ºæ ¹ç›®å½•é‡å®šå‘
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <meta http-equiv="refresh" content="0; url=./web-ide/">
              <title>éª†è¨€åœ¨çº¿IDE</title>
          </head>
          <body>
              <p>æ­£åœ¨è·³è½¬åˆ°éª†è¨€åœ¨çº¿IDE... <a href="./web-ide/">ç‚¹å‡»è¿™é‡Œ</a></p>
          </body>
          </html>
          EOF
          
          echo "ğŸ“¦ éƒ¨ç½²æ–‡ä»¶å‡†å¤‡å®Œæˆ"
          ls -la _site/
          
      - name: ğŸ” éªŒè¯æ„å»ºç»“æœ
        run: |
          echo "ğŸ“Š IDEæ–‡ä»¶ç»Ÿè®¡:"
          find _site/web-ide -type f -name "*.html" -o -name "*.js" -o -name "*.css" | wc -l
          echo "ğŸ“ æ–‡ä»¶æ¸…å•æ£€æŸ¥:"
          if [ -f "_site/web-ide/file-manifest.js" ]; then
            echo "âœ… æ–‡ä»¶æ¸…å•å­˜åœ¨"
            head -5 _site/web-ide/file-manifest.js
          else
            echo "âŒ æ–‡ä»¶æ¸…å•ç¼ºå¤±"
            exit 1
          fi
          
      - name: ğŸ“¤ é…ç½®Pages
        uses: actions/configure-pages@v4
        
      - name: ğŸ“¦ ä¸Šä¼ æ„å»ºæ–‡ä»¶
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

  # éƒ¨ç½²ä½œä¸š
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}web-ide/
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸš€ éƒ¨ç½²åˆ°GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: ğŸ“¢ éƒ¨ç½²å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ éª†è¨€åœ¨çº¿IDEéƒ¨ç½²æˆåŠŸ!"
          echo "ğŸ”— è®¿é—®åœ°å€: ${{ steps.deployment.outputs.page_url }}web-ide/"
          echo "ğŸ“± ç§»åŠ¨ç«¯ä¼˜åŒ–: æ”¯æŒå“åº”å¼è®¾è®¡"
          echo "ğŸŒ“ ä¸»é¢˜åˆ‡æ¢: æ”¯æŒæ·±è‰²/æµ…è‰²æ¨¡å¼"
          echo "ğŸ“ ä»£ç ç¼–è¾‘: æ”¯æŒ402ä¸ªé¡¹ç›®æ–‡ä»¶"