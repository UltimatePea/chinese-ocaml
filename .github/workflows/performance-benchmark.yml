name: æ€§èƒ½åŸºå‡†æµ‹è¯•å’Œå›å½’æ£€æµ‹
# Performance Benchmark and Regression Detection Workflow

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å‘¨æ—¥åˆå¤œè¿è¡Œå®Œæ•´åŸºå‡†æµ‹è¯•
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      benchmark_type:
        description: 'åŸºå‡†æµ‹è¯•ç±»å‹'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - quick
        - regression-only

env:
  BENCHMARK_RESULTS_DIR: 'benchmarks/results'
  BASELINE_BRANCH: 'main'

jobs:
  performance-benchmark:
    name: æ€§èƒ½åŸºå‡†æµ‹è¯•
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        ocaml-compiler: 
          - "5.3.0"  # å½“å‰æ”¯æŒçš„OCamlç‰ˆæœ¬
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºåŸºçº¿å¯¹æ¯”
    
    - name: è®¾ç½®OCamlç¯å¢ƒ
      uses: ocaml/setup-ocaml@v2
      with:
        ocaml-compiler: ${{ matrix.ocaml-compiler }}
        dune-cache: true
        opam-disable-sandboxing: true
    
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y time valgrind bc
    
    - name: å®‰è£…OCamlä¾èµ–
      run: |
        opam install --deps-only --with-test --with-doc .
        opam install benchmark core_bench
    
    - name: æ„å»ºé¡¹ç›®
      run: |
        dune build
        dune build @install
    
    - name: åˆ›å»ºåŸºå‡†æµ‹è¯•ç»“æœç›®å½•
      run: |
        mkdir -p ${{ env.BENCHMARK_RESULTS_DIR }}
        mkdir -p .benchmark_cache
    
    - name: æ£€æŸ¥åŸºå‡†æµ‹è¯•ç±»å‹
      id: benchmark-type
      run: |
        if [ "${{ github.event.inputs.benchmark_type }}" = "quick" ]; then
          echo "type=quick" >> $GITHUB_OUTPUT
        elif [ "${{ github.event.inputs.benchmark_type }}" = "regression-only" ]; then
          echo "type=regression" >> $GITHUB_OUTPUT
        else
          echo "type=full" >> $GITHUB_OUTPUT
        fi
    
    - name: è¿è¡ŒåŸºç¡€åŠŸèƒ½æµ‹è¯•
      run: |
        echo "ğŸ§ª è¿è¡ŒåŸºç¡€åŠŸèƒ½æµ‹è¯•ä»¥ç¡®ä¿ç³»ç»Ÿç¨³å®š..."
        dune runtest --root . test_performance_benchmark
    
    - name: è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯• (å¿«é€Ÿæ¨¡å¼)
      if: steps.benchmark-type.outputs.type == 'quick'
      run: |
        echo "âš¡ è¿è¡Œå¿«é€Ÿæ€§èƒ½åŸºå‡†æµ‹è¯•..."
        timestamp=$(date +"%Y%m%d_%H%M%S")
        report_file="${{ env.BENCHMARK_RESULTS_DIR }}/quick_benchmark_${timestamp}.md"
        
        dune exec test/test_performance_benchmark.exe > "$report_file" 2>&1
        echo "å¿«é€ŸåŸºå‡†æµ‹è¯•æŠ¥å‘Šä¿å­˜åˆ°: $report_file"
        
        # ä¸Šä¼ å¿«é€Ÿæµ‹è¯•ç»“æœ
        echo "QUICK_REPORT_FILE=$report_file" >> $GITHUB_ENV
    
    - name: è¿è¡Œå®Œæ•´æ€§èƒ½åŸºå‡†æµ‹è¯• (å®Œæ•´æ¨¡å¼)
      if: steps.benchmark-type.outputs.type == 'full'
      run: |
        echo "ğŸ”„ è¿è¡Œå®Œæ•´æ€§èƒ½åŸºå‡†æµ‹è¯•..."
        timestamp=$(date +"%Y%m%d_%H%M%S")
        report_file="${{ env.BENCHMARK_RESULTS_DIR }}/full_benchmark_${timestamp}.md"
        
        # è¿è¡Œå®Œæ•´åŸºå‡†æµ‹è¯•å¥—ä»¶
        timeout 1800 dune exec test/test_performance_benchmark.exe > "$report_file" 2>&1 || echo "åŸºå‡†æµ‹è¯•å®Œæˆæˆ–è¶…æ—¶"
        
        # è¿è¡Œç°æœ‰çš„è„šæœ¬åŒ–åŸºå‡†æµ‹è¯•
        if [ -f "æ€§èƒ½æµ‹è¯•/scripts/run_benchmark.sh" ]; then
          echo "è¿è¡Œç°æœ‰åŸºå‡†æµ‹è¯•è„šæœ¬..."
          bash æ€§èƒ½æµ‹è¯•/scripts/run_benchmark.sh >> "$report_file" 2>&1 || echo "è„šæœ¬åŒ–æµ‹è¯•å®Œæˆ"
        fi
        
        echo "å®Œæ•´åŸºå‡†æµ‹è¯•æŠ¥å‘Šä¿å­˜åˆ°: $report_file"
        echo "FULL_REPORT_FILE=$report_file" >> $GITHUB_ENV
    
    - name: è·å–åŸºçº¿æ€§èƒ½æ•°æ®
      if: steps.benchmark-type.outputs.type == 'full' || steps.benchmark-type.outputs.type == 'regression'
      run: |
        echo "ğŸ“Š è·å–åŸºçº¿æ€§èƒ½æ•°æ®è¿›è¡Œå¯¹æ¯”..."
        
        # å°è¯•ä»ä¸»åˆ†æ”¯è·å–æœ€æ–°çš„åŸºå‡†æµ‹è¯•ç»“æœ
        baseline_file=".benchmark_cache/baseline_performance.json"
        
        if [ "${{ github.ref }}" != "refs/heads/main" ]; then
          # å¦‚æœä¸æ˜¯ä¸»åˆ†æ”¯ï¼Œå°è¯•è·å–ä¸»åˆ†æ”¯çš„åŸºçº¿æ•°æ®
          git show main:${{ env.BENCHMARK_RESULTS_DIR }}/latest_baseline.json > "$baseline_file" 2>/dev/null || echo "æ— æ³•è·å–åŸºçº¿æ•°æ®ï¼Œå°†åˆ›å»ºæ–°åŸºçº¿"
        fi
        
        echo "BASELINE_FILE=$baseline_file" >> $GITHUB_ENV
    
    - name: æ€§èƒ½å›å½’æ£€æµ‹
      if: steps.benchmark-type.outputs.type == 'regression' || steps.benchmark-type.outputs.type == 'full'
      run: |
        echo "ğŸ” è¿è¡Œæ€§èƒ½å›å½’æ£€æµ‹..."
        
        current_results="${{ env.FULL_REPORT_FILE:-${{ env.QUICK_REPORT_FILE }} }}"
        baseline_results="${{ env.BASELINE_FILE }}"
        
        if [ -f "$baseline_results" ] && [ -f "$current_results" ]; then
          echo "å¯¹æ¯”å½“å‰ç»“æœä¸åŸºçº¿..."
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„å›å½’æ£€æµ‹é€»è¾‘
          regression_report="${{ env.BENCHMARK_RESULTS_DIR }}/regression_$(date +%Y%m%d_%H%M%S).md"
          
          echo "# æ€§èƒ½å›å½’æ£€æµ‹æŠ¥å‘Š" > "$regression_report"
          echo "**æ£€æµ‹æ—¶é—´**: $(date)" >> "$regression_report"
          echo "**åŸºçº¿æ¥æº**: $baseline_results" >> "$regression_report"
          echo "**å½“å‰ç»“æœ**: $current_results" >> "$regression_report"
          echo "" >> "$regression_report"
          
          # ç®€å•çš„æ€§èƒ½å¯¹æ¯”ï¼ˆå®é™…é¡¹ç›®ä¸­å¯ä»¥æ›´å¤æ‚ï¼‰
          echo "## æ€§èƒ½å¯¹æ¯”æ‘˜è¦" >> "$regression_report"
          echo "è¯¦ç»†çš„æ€§èƒ½å›å½’åˆ†æå°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°ã€‚" >> "$regression_report"
          
          echo "REGRESSION_REPORT=$regression_report" >> $GITHUB_ENV
        else
          echo "âš ï¸ ç¼ºå°‘åŸºçº¿æ•°æ®æˆ–å½“å‰ç»“æœï¼Œè·³è¿‡å›å½’æ£€æµ‹"
        fi
    
    - name: ç”Ÿæˆæ€§èƒ½è¶‹åŠ¿å›¾è¡¨ (å¯é€‰)
      if: steps.benchmark-type.outputs.type == 'full'
      run: |
        echo "ğŸ“ˆ ç”Ÿæˆæ€§èƒ½è¶‹åŠ¿å›¾è¡¨..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ å›¾è¡¨ç”Ÿæˆé€»è¾‘ï¼Œæ¯”å¦‚ä½¿ç”¨Pythonè„šæœ¬
        # python3 scripts/generate_performance_charts.py
        echo "æ€§èƒ½è¶‹åŠ¿å›¾è¡¨ç”ŸæˆåŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°"
    
    - name: æ›´æ–°åŸºçº¿æ•°æ® (ä»…ä¸»åˆ†æ”¯)
      if: github.ref == 'refs/heads/main' && steps.benchmark-type.outputs.type == 'full'
      run: |
        echo "ğŸ’¾ æ›´æ–°ä¸»åˆ†æ”¯åŸºçº¿æ€§èƒ½æ•°æ®..."
        
        if [ -n "${{ env.FULL_REPORT_FILE }}" ]; then
          # å¤åˆ¶å½“å‰ç»“æœä½œä¸ºæ–°çš„åŸºçº¿
          cp "${{ env.FULL_REPORT_FILE }}" "${{ env.BENCHMARK_RESULTS_DIR }}/latest_baseline.json"
          
          # æäº¤åŸºçº¿æ•°æ®æ›´æ–°
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add "${{ env.BENCHMARK_RESULTS_DIR }}/latest_baseline.json"
          git commit -m "æ›´æ–°æ€§èƒ½åŸºçº¿æ•°æ® - $(date +%Y-%m-%d)" || echo "æ— åŸºçº¿æ•°æ®å˜æ›´"
        fi
    
    - name: ä¸Šä¼ æ€§èƒ½æµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v4
      with:
        name: performance-benchmark-results-${{ matrix.ocaml-compiler }}
        path: |
          ${{ env.BENCHMARK_RESULTS_DIR }}/*.md
          ${{ env.BENCHMARK_RESULTS_DIR }}/*.json
        retention-days: 30
    
    - name: è¯„ä¼°æ€§èƒ½æµ‹è¯•ç»“æœ
      id: performance-evaluation
      run: |
        echo "ğŸ“‹ è¯„ä¼°æ€§èƒ½æµ‹è¯•ç»“æœ..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ä¸¥é‡çš„æ€§èƒ½å›å½’
        performance_status="success"
        if [ -f "${{ env.REGRESSION_REPORT }}" ]; then
          # æ£€æŸ¥å›å½’æŠ¥å‘Šä¸­çš„è­¦å‘Š
          if grep -q "æ€§èƒ½æ˜æ˜¾è½å" "${{ env.REGRESSION_REPORT }}"; then
            performance_status="warning"
            echo "âš ï¸ æ£€æµ‹åˆ°æ€§èƒ½å›å½’è­¦å‘Š"
          fi
        fi
        
        echo "status=$performance_status" >> $GITHUB_OUTPUT
        
        # ç”Ÿæˆæ‘˜è¦ä¿¡æ¯
        echo "## ğŸš€ æ€§èƒ½åŸºå‡†æµ‹è¯•æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "**æµ‹è¯•ç±»å‹**: ${{ steps.benchmark-type.outputs.type }}" >> $GITHUB_STEP_SUMMARY
        echo "**OCamlç‰ˆæœ¬**: ${{ matrix.ocaml-compiler }}" >> $GITHUB_STEP_SUMMARY
        echo "**æ‰§è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "${{ env.FULL_REPORT_FILE }}" ]; then
          echo "**å®Œæ•´æŠ¥å‘Š**: ${{ env.FULL_REPORT_FILE }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -n "${{ env.REGRESSION_REPORT }}" ]; then
          echo "**å›å½’æ£€æµ‹**: ${{ env.REGRESSION_REPORT }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "**æ€§èƒ½çŠ¶æ€**: $performance_status" >> $GITHUB_STEP_SUMMARY
    
    - name: åˆ›å»ºæ€§èƒ½å›å½’Issue (å¦‚æœ‰å¿…è¦)
      if: steps.performance-evaluation.outputs.status == 'warning' && github.event_name == 'push'
      uses: actions/github-script@v7
      with:
        script: |
          const title = `æ€§èƒ½å›å½’è­¦å‘Š - ${new Date().toISOString().split('T')[0]}`;
          const body = `
          ## ğŸš¨ æ€§èƒ½å›å½’æ£€æµ‹è­¦å‘Š
          
          åœ¨æœ€æ–°çš„æ€§èƒ½åŸºå‡†æµ‹è¯•ä¸­æ£€æµ‹åˆ°æ½œåœ¨çš„æ€§èƒ½å›å½’é—®é¢˜ã€‚
          
          **æ£€æµ‹æ—¶é—´**: ${new Date().toISOString()}
          **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          **åˆ†æ”¯**: ${{ github.ref }}
          
          ## è¯¦ç»†ä¿¡æ¯
          
          è¯·æŸ¥çœ‹ä»¥ä¸‹æ–‡ä»¶äº†è§£è¯¦ç»†çš„æ€§èƒ½åˆ†æç»“æœï¼š
          - æ€§èƒ½åŸºå‡†æµ‹è¯•æŠ¥å‘Š: ${{ env.FULL_REPORT_FILE || env.QUICK_REPORT_FILE }}
          - å›å½’æ£€æµ‹æŠ¥å‘Š: ${{ env.REGRESSION_REPORT }}
          
          ## å»ºè®®æ“ä½œ
          
          1. æ£€æŸ¥æœ€è¿‘çš„ä»£ç å˜æ›´æ˜¯å¦å¼•å…¥äº†æ€§èƒ½é—®é¢˜
          2. è¿è¡Œæœ¬åœ°æ€§èƒ½æµ‹è¯•éªŒè¯ç»“æœ
          3. å¦‚ç¡®è®¤å­˜åœ¨æ€§èƒ½é—®é¢˜ï¼Œè¯·åŠæ—¶ä¼˜åŒ–
          4. è€ƒè™‘æ˜¯å¦éœ€è¦è°ƒæ•´æ€§èƒ½é˜ˆå€¼
          
          ## è‡ªåŠ¨åŒ–ä¿¡æ¯
          
          æ­¤Issueç”±æ€§èƒ½åŸºå‡†æµ‹è¯•CIè‡ªåŠ¨åˆ›å»ºã€‚å¦‚æœè¿™æ˜¯è¯¯æŠ¥ï¼Œè¯·å…³é—­æ­¤Issueå¹¶è€ƒè™‘è°ƒæ•´å›å½’æ£€æµ‹é˜ˆå€¼ã€‚
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['performance', 'regression', 'automated', 'needs-investigation']
          });
    
    - name: å‘å¸ƒPRè¯„è®º (æ€§èƒ½æµ‹è¯•ç»“æœ)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const performanceStatus = '${{ steps.performance-evaluation.outputs.status }}';
          const benchmarkType = '${{ steps.benchmark-type.outputs.type }}';
          
          let statusEmoji = 'âœ…';
          let statusText = 'æ€§èƒ½æµ‹è¯•é€šè¿‡';
          
          if (performanceStatus === 'warning') {
            statusEmoji = 'âš ï¸';
            statusText = 'æ£€æµ‹åˆ°æ€§èƒ½å›å½’è­¦å‘Š';
          }
          
          const comment = `
          ## ${statusEmoji} æ€§èƒ½åŸºå‡†æµ‹è¯•ç»“æœ
          
          **æµ‹è¯•ç±»å‹**: ${benchmarkType}
          **æµ‹è¯•çŠ¶æ€**: ${statusText}
          **OCamlç‰ˆæœ¬**: ${{ matrix.ocaml-compiler }}
          
          ### ğŸ“Š æµ‹è¯•æ‘˜è¦
          
          - âœ… **åŸºç¡€åŠŸèƒ½æµ‹è¯•**: é€šè¿‡
          - ğŸ“ˆ **æ€§èƒ½åŸºå‡†æµ‹è¯•**: ${performanceStatus === 'success' ? 'é€šè¿‡' : 'æœ‰è­¦å‘Š'}
          ${performanceStatus === 'warning' ? '- âš ï¸ **å›å½’æ£€æµ‹**: å‘ç°æ½œåœ¨æ€§èƒ½é—®é¢˜' : ''}
          
          ### ğŸ“ è¯¦ç»†æŠ¥å‘Š
          
          å®Œæ•´çš„æ€§èƒ½æµ‹è¯•ç»“æœå·²ä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼Œå¯åœ¨Actionsé¡µé¢ä¸‹è½½æŸ¥çœ‹ã€‚
          
          ${performanceStatus === 'warning' ? 
          'âš ï¸ **æ³¨æ„**: æ£€æµ‹åˆ°æ½œåœ¨çš„æ€§èƒ½å›å½’ï¼Œå»ºè®®æ£€æŸ¥æœ€è¿‘çš„ä»£ç å˜æ›´ã€‚' : 
          'ğŸ‰ **å¤ªå¥½äº†**: æ‰€æœ‰æ€§èƒ½æµ‹è¯•å‡é€šè¿‡ï¼Œæ²¡æœ‰æ£€æµ‹åˆ°æ€§èƒ½å›å½’ã€‚'}
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  cleanup:
    name: æ¸…ç†å’Œå½’æ¡£
    runs-on: ubuntu-latest
    needs: performance-benchmark
    if: always()
    
    steps:
    - name: æ¸…ç†æ—§çš„åŸºå‡†æµ‹è¯•ç»“æœ
      run: |
        echo "ğŸ§¹ æ¸…ç†è¶…è¿‡30å¤©çš„æ—§åŸºå‡†æµ‹è¯•ç»“æœ..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…ç†é€»è¾‘ï¼Œæ¯”å¦‚åˆ é™¤è¿‡æœŸçš„åŸºå‡†æµ‹è¯•æ–‡ä»¶
        echo "æ¸…ç†åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°"
    
    - name: å½’æ¡£é‡è¦ç»“æœ
      run: |
        echo "ğŸ“¦ å½’æ¡£é‡è¦çš„åŸºå‡†æµ‹è¯•ç»“æœ..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ å½’æ¡£é€»è¾‘ï¼Œæ¯”å¦‚å°†é‡è¦ç»“æœä¸Šä¼ åˆ°å¤–éƒ¨å­˜å‚¨
        echo "å½’æ¡£åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°"