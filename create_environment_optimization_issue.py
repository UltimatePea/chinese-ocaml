#!/usr/bin/env python3
"""
åˆ›å»ºç¯å¢ƒä¼˜åŒ–å’Œå¼€å‘å·¥å…·æ”¹è¿›issue
"""

import json
import requests
from github_auth import get_installation_token

def create_issue():
    """åˆ›å»ºGitHub issue"""
    token = get_installation_token()
    
    headers = {
        'Authorization': f'token {token}',
        'Accept': 'application/vnd.github+json'
    }
    
    title = "æŠ€æœ¯å€ºåŠ¡æ”¹è¿›ï¼šç¯å¢ƒä¼˜åŒ–å’Œå¼€å‘å·¥å…·å¢å¼º Fix #730"
    
    body = """## ğŸ“‹ é—®é¢˜æè¿°

æ ¹æ®æœ€æ–°çš„æŠ€æœ¯å€ºåŠ¡åˆ†ææŠ¥å‘Šï¼ˆ2025-07-20ï¼‰ï¼Œéª†è¨€é¡¹ç›®æ•´ä½“ä»£ç è´¨é‡ä¼˜ç§€ï¼Œä½†å­˜åœ¨ä¸€äº›ç¯å¢ƒé…ç½®å’Œå¼€å‘å·¥å…·ä¼˜åŒ–æœºä¼šã€‚æœ¬issueæ—¨åœ¨å¤„ç†æœ€é«˜ä¼˜å…ˆçº§çš„æŠ€æœ¯å€ºåŠ¡ï¼Œæå‡å¼€å‘ä½“éªŒå’Œé¡¹ç›®ç»´æŠ¤æ•ˆç‡ã€‚

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

### ä¼˜å…ˆçº§1ï¼šç«‹å³æ‰§è¡Œï¼ˆä»Šæ—¥å†…ï¼‰

#### 1. ç¯å¢ƒæ¸…ç†å’Œä¼˜åŒ–
- **æ„å»ºäº§ç‰©æ¸…ç†**ï¼šå½“å‰`_build/`ç›®å½•å ç”¨440MBç©ºé—´
- **ä¸´æ—¶æ–‡ä»¶ç®¡ç†**ï¼šè§„èŒƒåŒ–æ—¥å¿—æ–‡ä»¶å’Œè°ƒè¯•è¾“å‡º
- **Gitå¿½ç•¥è§„åˆ™**ï¼šå®Œå–„`.gitignore`æ–‡ä»¶

#### 2. å¼€å‘å·¥å…·å¢å¼º
- **è´¨é‡æ£€æŸ¥è„šæœ¬**ï¼šåˆ›å»ºä¸€é”®ä»£ç è´¨é‡æ£€æŸ¥å·¥å…·
- **å¿«é€Ÿæµ‹è¯•å‘½ä»¤**ï¼šå»ºç«‹é«˜æ•ˆçš„æµ‹è¯•è¿è¡Œæœºåˆ¶
- **æ„å»ºä¼˜åŒ–**ï¼šæ”¹è¿›ç¼–è¯‘æ—¶é—´å’Œè¾“å‡ºç®¡ç†

### ä¼˜å…ˆçº§2ï¼šçŸ­æœŸæ”¹è¿›ï¼ˆ1-2å‘¨ï¼‰

#### 3. æµ‹è¯•è¦†ç›–ç‡æå‡
- **å½“å‰çŠ¶æ€**ï¼š30.3%è¦†ç›–ç‡
- **ç›®æ ‡çŠ¶æ€**ï¼š50%+è¦†ç›–ç‡
- **é‡ç‚¹æ¨¡å—**ï¼šcore_types.ml, lexer_utils.ml, parser_utils.ml

#### 4. æ€§èƒ½ç›‘æ§åŸºç¡€
- **è¯—è¯å¤„ç†æ€§èƒ½åŸºå‡†**
- **è¯æ³•åˆ†ææ€§èƒ½ç›‘æ§**
- **å…³é”®è·¯å¾„æ—¶é—´æµ‹é‡**

## ğŸ› ï¸ æŠ€æœ¯å®æ–½æ–¹æ¡ˆ

### ç¯å¢ƒæ¸…ç†
```bash
# æ„å»ºäº§ç‰©æ¸…ç†
dune clean
rm -rf _build/

# ä¸´æ—¶æ–‡ä»¶æ¸…ç†
rm -f claude.log build_output.log ascii_check_results.txt
find . -name "*.tmp" -delete
find . -name "*~" -delete
```

### å¼€å‘å·¥å…·è„šæœ¬
```bash
# scripts/quality_check.sh
#!/bin/bash
dune build
dune test
dune exec -- luoyan --version
echo "âœ… è´¨é‡æ£€æŸ¥å®Œæˆ"

# scripts/quick_test.sh
#!/bin/bash
dune exec test/test_minimal.exe
dune exec test/test_simple_token_mapper.exe
echo "âœ… æ ¸å¿ƒæµ‹è¯•é€šè¿‡"
```

### .gitignoreå¢å¼º
```
# æ„å»ºäº§ç‰©
_build/
*.install

# ä¸´æ—¶æ–‡ä»¶
*.log
*.tmp
*~
.DS_Store

# IDEæ–‡ä»¶
.vscode/
*.swp
*.swo

# è°ƒè¯•è¾“å‡º
ascii_check_results.txt
build_output.log
```

## ğŸ“Š è´¨é‡æŒ‡æ ‡

### å½“å‰çŠ¶æ€
- æºæ–‡ä»¶ï¼š290ä¸ª (.ml)
- æ¥å£æ–‡ä»¶ï¼š274ä¸ª (.mli)
- æµ‹è¯•è¦†ç›–ç‡ï¼š30.3%
- æ„å»ºäº§ç‰©ï¼š440MB
- æ„å»ºçŠ¶æ€ï¼šâœ… é›¶è­¦å‘Šé›¶é”™è¯¯

### ç›®æ ‡çŠ¶æ€
- æµ‹è¯•è¦†ç›–ç‡ï¼š50%+
- æ„å»ºäº§ç‰©ï¼š<50MB
- å¼€å‘å·¥å…·ï¼šå®Œæ•´çš„è´¨é‡æ£€æŸ¥å¥—ä»¶
- æ€§èƒ½ç›‘æ§ï¼šå»ºç«‹åŸºå‡†æµ‹è¯•

## ğŸ¨ è‰ºæœ¯æ€§è€ƒè™‘

éµå¾ªéª†è¨€é¡¹ç›®çš„æ ¸å¿ƒä»·å€¼è§‚ï¼š

1. **ä¿æŒè¯—è¯ç¼–ç¨‹ç‰¹è‰²**ï¼šæ‰€æœ‰æ”¹è¿›ä¸å½±å“é¡¹ç›®çš„ä¸­æ–‡ç¼–ç¨‹ç¾å­¦
2. **è‡ªä¸¾ç¼–è¯‘å™¨ä¼˜å…ˆ**ï¼šé‡ç‚¹å…³æ³¨è‡ªä¸¾ç¼–è¯‘å™¨çš„å¼€å‘ä½“éªŒ
3. **ä¸­æ–‡æ€ç»´å¯¼å‘**ï¼šå¼€å‘å·¥å…·çš„è¾“å‡ºå’Œæ–‡æ¡£ä¿æŒä¸­æ–‡é£æ ¼

## âœ… éªŒæ”¶æ ‡å‡†

### åŸºç¡€ç¯å¢ƒä¼˜åŒ–
- [ ] `_build/`ç›®å½•æ¸…ç†å®Œæˆï¼Œé‡Šæ”¾440MBç©ºé—´
- [ ] ä¸´æ—¶æ–‡ä»¶æ¸…ç†è§„åˆ™å»ºç«‹
- [ ] `.gitignore`è§„åˆ™å®Œå–„

### å¼€å‘å·¥å…·å¢å¼º
- [ ] `scripts/quality_check.sh`è„šæœ¬åˆ›å»ºå¹¶æµ‹è¯•
- [ ] `scripts/quick_test.sh`å¿«é€Ÿæµ‹è¯•å·¥å…·
- [ ] æ„å»ºæ—¶é—´ä¼˜åŒ–ï¼Œæå‡å¼€å‘æ•ˆç‡

### æµ‹è¯•åŸºç¡€å»ºç«‹
- [ ] æ ¸å¿ƒæ¨¡å—æµ‹è¯•ç”¨ä¾‹å¢åŠ 
- [ ] æµ‹è¯•è¦†ç›–ç‡ç›‘æ§æœºåˆ¶
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•æ¡†æ¶

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

1. **å¼€å‘æ•ˆç‡æå‡**ï¼š40%çš„æ„å»ºå’Œæµ‹è¯•æ—¶é—´ä¼˜åŒ–
2. **ä»£ç è´¨é‡ä¿éšœ**ï¼šè‡ªåŠ¨åŒ–è´¨é‡æ£€æŸ¥è¦†ç›–
3. **ç»´æŠ¤æˆæœ¬é™ä½**ï¼šè§„èŒƒåŒ–çš„ç¯å¢ƒç®¡ç†
4. **æµ‹è¯•ä¿¡å¿ƒå¢å¼º**ï¼šæ›´é«˜çš„ä»£ç è¦†ç›–ç‡

## ğŸš€ å®æ–½æ—¶é—´çº¿

- **ç¬¬1å¤©**ï¼šç¯å¢ƒæ¸…ç†å’ŒåŸºç¡€å·¥å…·è„šæœ¬
- **ç¬¬2-3å¤©**ï¼šæµ‹è¯•è¦†ç›–ç‡åŸºç¡€å»ºç«‹
- **ç¬¬1å‘¨**ï¼šæ€§èƒ½ç›‘æ§æ¡†æ¶æ­å»º
- **ç¬¬2å‘¨**ï¼šè´¨é‡æ£€æŸ¥è‡ªåŠ¨åŒ–å®Œå–„

---

**æ ‡ç­¾**: æŠ€æœ¯å€ºåŠ¡, å¼€å‘å·¥å…·, æµ‹è¯•ä¼˜åŒ–, æ€§èƒ½ç›‘æ§, ç¯å¢ƒé…ç½®

æ­¤issueä¸“æ³¨äºé«˜ä¼˜å…ˆçº§æŠ€æœ¯å€ºåŠ¡ï¼Œé€šè¿‡ç¯å¢ƒä¼˜åŒ–å’Œå¼€å‘å·¥å…·å¢å¼ºï¼Œä¸ºéª†è¨€é¡¹ç›®çš„æŒç»­å‘å±•å¥ å®šæ›´åŠ åšå®çš„æŠ€æœ¯åŸºç¡€ã€‚
"""
    
    data = {
        'title': title,
        'body': body,
        'labels': ['æŠ€æœ¯å€ºåŠ¡', 'å¼€å‘å·¥å…·', 'æµ‹è¯•ä¼˜åŒ–', 'æ€§èƒ½ç›‘æ§']
    }
    
    url = 'https://api.github.com/repos/UltimatePea/chinese-ocaml/issues'
    
    response = requests.post(url, headers=headers, json=data)
    response.raise_for_status()
    
    issue_data = response.json()
    print(f"âœ… Issue #{issue_data['number']} åˆ›å»ºæˆåŠŸ!")
    print(f"æ ‡é¢˜: {issue_data['title']}")
    print(f"URL: {issue_data['html_url']}")
    
    return issue_data['number']

def main():
    try:
        issue_number = create_issue()
        print(f"\nğŸ¯ ä¸‹ä¸€æ­¥ï¼šåˆ›å»ºPRæ¥è§£å†³Issue #{issue_number}")
        return 0
    except Exception as e:
        print(f"âŒ åˆ›å»ºissueå¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return 1

if __name__ == '__main__':
    exit(main())