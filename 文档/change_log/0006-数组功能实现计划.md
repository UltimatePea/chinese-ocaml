# 数组功能实现计划

## 当前状态分析

### ✅ 已存在的基础设施
- **AST节点定义** (src/ast.ml:125-127):
  - `ArrayExpr of expr list` - 数组字面量 `[|1; 2; 3|]`
  - `ArrayAccessExpr of expr * expr` - 数组访问 `arr.(index)`
  - `ArrayUpdateExpr of expr * expr * expr` - 数组更新 `arr.(index) <- value`

- **词法标记定义** (src/lexer.ml:138-139):
  - `LeftArray` (`[|`)
  - `RightArray` (`|]`)

- **复合标识符保护** (src/lexer.ml:257-260):
  - "数组"、"数组长度"、"数组操作"等已在保留词列表中

### ❌ 缺失的核心功能

1. **词法分析器实现**
   - `[|` 和 `|]` 标记的实际匹配逻辑
   - `.( )` 数组访问语法的词法分析

2. **语法分析器实现**  
   - 数组字面量解析: `[|expr1; expr2; ...|]`
   - 数组访问解析: `expr.(expr)`
   - 数组更新解析: `expr.(expr) <- expr`

3. **代码生成器实现**
   - 数组字面量的运行时表示
   - 数组访问的求值逻辑
   - 数组更新的副作用处理

4. **内置函数支持**
   - `创建数组` 函数
   - `数组长度` 函数  
   - `复制数组` 函数

## 测试现状

### 当前数组测试结果 (13个测试, 5个失败)
- ✅ **数组字面量** - 神奇地通过了，需要调查原因
- ❌ **数组访问** - `arr.(index)` 语法不被识别
- ✅ **数组更新** - 意外通过，可能有其他解析逻辑
- ❌ **创建数组** - `创建数组 5` 函数未定义
- ✅ **数组长度** - 可能有现有实现
- ❌ **复制数组** - `复制数组` 函数未定义
- ❌ **嵌套数组** - 复杂嵌套解析失败
- ❌ **函数中使用数组** - 参数传递问题
- ✅ **数组基本排序** - 可能使用了替代语法

## 实施计划

### 阶段1: 词法分析器完善
1. 实现 `[|` 和 `|]` 的词法匹配
2. 确保 `.(` 语法被正确分词为 `Dot` + `LeftParen`
3. 测试复合标记的边界检查

### 阶段2: 语法分析器实现
1. 在表达式解析中添加数组字面量支持
2. 实现数组访问表达式解析
3. 实现数组更新语句解析
4. 确保运算符优先级正确

### 阶段3: 代码生成器实现
1. 为 `ArrayExpr` 添加求值逻辑
2. 为 `ArrayAccessExpr` 添加访问逻辑
3. 为 `ArrayUpdateExpr` 添加更新逻辑
4. 处理运行时错误(越界访问等)

### 阶段4: 内置函数扩展
1. 实现 `创建数组` 函数
2. 实现 `复制数组` 函数
3. 确保 `数组长度` 函数正常工作
4. 添加其他数组操作函数

### 阶段5: 测试验证和优化
1. 修复所有数组相关测试
2. 添加边界情况测试
3. 性能优化和错误处理改进

## 技术难点

1. **运行时值类型扩展** - 需要在 `value` 类型中添加数组支持
2. **可变性处理** - 数组更新涉及副作用，需要正确的内存管理
3. **类型检查** - 确保数组元素类型一致性
4. **错误处理** - 越界访问、类型不匹配等运行时错误

## 预期效果

完成后应达到:
- 数组测试: 5个失败 → 0个失败 (100%成功率)
- 完整的数组操作支持，包括创建、访问、更新、内置函数
- 为wenyan语法下一阶段奠定数据结构基础

## 时间估算

- 阶段1-2: 词法和语法分析 (2-3小时)
- 阶段3: 代码生成器 (2-3小时)  
- 阶段4: 内置函数 (1-2小时)
- 阶段5: 测试和优化 (1小时)

总计: 6-9小时的开发工作

---
*创建日期: 2025-07-12*
*状态: 计划阶段*