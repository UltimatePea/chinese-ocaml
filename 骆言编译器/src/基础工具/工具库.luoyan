(* 
 * 骆言自举编译器基础工具库
 * 提供编译器所需的基础功能和数据结构
 *)

(* 字符串处理工具 *)
让 字符串连接 = 函数 s1 s2 ->
  字符串连接 s1 s2

让 字符串长度 = 函数 s ->
  (* 这里需要调用内置函数，暂时使用占位符 *)
  内置_字符串长度 s

让 字符串_从_整数 = 函数 n ->
  (* 整数转字符串 *)
  字符串_从_整数 n

让 整数_从_字符串 = 函数 s ->
  (* 字符串转整数 *)
  整数_从_字符串 s

让 字符串_以_开头 = 函数 字符串 前缀 ->
  (* 检查字符串是否以指定前缀开头 *)
  让 字符串长度 = 内置_字符串长度 字符串 在
  让 前缀长度 = 内置_字符串长度 前缀 在
  如果 前缀长度 > 字符串长度
  那么 假
  否则
    让 子串 = 子字符串 字符串 0 前缀长度 在
    子串 = 前缀

让 字符串分割 = 函数 分隔符 字符串 ->
  (* 实现字符串按分隔符分割 *)
  让 递归 分割辅助 = 函数 当前字符串 分隔符 累积 ->
    匹配 查找分隔符 当前字符串 分隔符 的
    | 无 -> 累积 @ [当前字符串]
    | 有 位置 ->
      让 前部分 = 子字符串 当前字符串 0 位置 在
      让 后部分 = 子字符串 当前字符串 (位置 + 1) (字符串长度 当前字符串) 在
      分割辅助 后部分 分隔符 (累积 @ [前部分])
  在
  分割辅助 字符串 分隔符 []

(* 列表操作工具 *)
让 列表映射 = 函数 f 列表 ->
  匹配 列表 的
  | [] -> []
  | 头 :: 尾 -> (f 头) :: (列表映射 f 尾)

让 列表折叠左 = 函数 f 初值 列表 ->
  匹配 列表 的
  | [] -> 初值
  | 头 :: 尾 -> 列表折叠左 f (f 初值 头) 尾

让 列表折叠右 = 函数 f 列表 初值 ->
  匹配 列表 的
  | [] -> 初值
  | 头 :: 尾 -> f 头 (列表折叠右 f 尾 初值)

让 列表过滤 = 函数 谓词 列表 ->
  匹配 列表 的
  | [] -> []
  | 头 :: 尾 when 谓词 头 -> 头 :: (列表过滤 谓词 尾)
  | _ :: 尾 -> 列表过滤 谓词 尾

让 列表连接 = 函数 列表1 列表2 ->
  匹配 列表1 的
  | [] -> 列表2
  | 头 :: 尾 -> 头 :: (列表连接 尾 列表2)

让 列表长度 = 函数 列表 ->
  让 递归 长度辅助 = 函数 lst 累积 ->
    匹配 lst 的
    | [] -> 累积
    | _ :: 尾 -> 长度辅助 尾 (累积 + 1)
  在
  长度辅助 列表 0

(* 选项类型操作 *)
类型 选项 T =
  | 无
  | 有 的 T

让 选项映射 = 函数 f 选项 ->
  匹配 选项 的
  | 无 -> 无
  | 有 值 -> 有 (f 值)

让 选项绑定 = 函数 选项 f ->
  匹配 选项 的
  | 无 -> 无
  | 有 值 -> f 值

让 选项或默认 = 函数 默认值 选项 ->
  匹配 选项 的
  | 无 -> 默认值
  | 有 值 -> 值

(* 结果类型 - 用于错误处理 *)
类型 结果 T E =
  | 成功 的 T
  | 失败 的 E

让 结果映射 = 函数 f 结果 ->
  匹配 结果 的
  | 成功 值 -> 成功 (f 值)
  | 失败 错误 -> 失败 错误

让 结果映射错误 = 函数 f 结果 ->
  匹配 结果 的
  | 成功 值 -> 成功 值
  | 失败 错误 -> 失败 (f 错误)

让 结果绑定 = 函数 结果 f ->
  匹配 结果 的
  | 成功 值 -> f 值
  | 失败 错误 -> 失败 错误

(* 文件操作 *)
让 读取文件 = 函数 文件路径 ->
  (* 调用内置文件读取函数 *)
  内置_读取文件 文件路径

让 读取_整个文件 = 函数 文件路径 ->
  (* 读取整个文件内容 *)
  内置_读取文件 文件路径

让 写入文件 = 函数 文件路径 内容 ->
  (* 调用内置文件写入函数 *)
  内置_写入文件 [文件路径; 内容]

让 文件存在 = 函数 文件路径 ->
  (* 检查文件是否存在 *)
  内置_文件存在 文件路径

(* 系统操作 *)
让 系统_参数列表 = 函数 () ->
  (* 获取命令行参数列表 *)
  系统_参数列表 ()

让 系统_退出 = 函数 退出码 ->
  (* 系统退出 *)
  系统_退出 退出码

(* 调试和日志输出 *)
让 调试输出 = 函数 消息 ->
  打印 ("DEBUG: " ^ 消息)

让 错误输出 = 函数 消息 ->
  打印 ("ERROR: " ^ 消息)

让 信息输出 = 函数 消息 ->
  打印 ("INFO: " ^ 消息)

(* 格式化字符串 - 简化版本 *)
让 格式化字符串 = 函数 模板 参数 ->
  (* 简化的字符串格式化，暂时只支持基本替换 *)
  模板  (* 待完善实现 *)

(* 比较工具 *)
让 字符串比较 = 函数 s1 s2 ->
  if s1 = s2 then 0
  else if s1 < s2 then -1
  else 1

让 整数比较 = 函数 n1 n2 ->
  if n1 = n2 then 0
  else if n1 < n2 then -1
  else 1

(* 通用比较类型 *)
类型 比较结果 =
  | 等于
  | 小于
  | 大于

让 比较结果转整数 = 函数 比较 ->
  匹配 比较 的
  | 等于 -> 0
  | 小于 -> -1
  | 大于 -> 1