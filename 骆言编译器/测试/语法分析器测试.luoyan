(*
 * 语法分析器测试
 * 验证语法分析器的基本功能
 *)

使用 基础工具.工具库
使用 基础工具.抽象语法树
使用 词法分析.词法分析器
使用 语法分析.语法分析器

(* 测试用例结构 *)
类型 语法测试用例 = {
  名称: 字符串;
  输入: 字符串;
  应该成功: 布尔值;
}

(* 基础语法测试用例 *)
让 基础语法测试用例列表 = [
  {
    名称 = "简单整数字面量";
    输入 = "42";
    应该成功 = true;
  };
  
  {
    名称 = "简单字符串字面量";
    输入 = "\"你好\"";
    应该成功 = true;
  };
  
  {
    名称 = "简单变量";
    输入 = "x";
    应该成功 = true;
  };
  
  {
    名称 = "算术表达式";
    输入 = "1 + 2";
    应该成功 = true;
  };
  
  {
    名称 = "复杂算术表达式";
    输入 = "1 + 2 * 3";
    应该成功 = true;
  };
  
  {
    名称 = "括号表达式";
    输入 = "(1 + 2) * 3";
    应该成功 = true;
  };
  
  {
    名称 = "条件表达式";
    输入 = "如果 真 那么 1 否则 2";
    应该成功 = true;
  };
  
  {
    名称 = "让绑定表达式";
    输入 = "让 x = 42 在 x + 1";
    应该成功 = true;
  };
  
  {
    名称 = "函数表达式";
    输入 = "函数 x -> x + 1";
    应该成功 = true;
  };
  
  {
    名称 = "多参数函数";
    输入 = "函数 x y -> x + y";
    应该成功 = true;
  };
  
  {
    名称 = "不匹配的括号";
    输入 = "(1 + 2";
    应该成功 = false;
  };
  
  {
    名称 = "缺少那么";
    输入 = "如果 真 1 否则 2";
    应该成功 = false;
  };
]

(* 运行单个语法测试用例 *)
让 运行语法测试用例 = 函数 测试用例 ->
  打印调试信息 ("运行语法测试: " ^ 测试用例.名称);
  
  (* 首先进行词法分析 *)
  匹配 词法分析 测试用例.输入 "测试文件" 的
  | 失败 错误信息 ->
      打印调试信息 ("词法分析失败: " ^ 测试用例.名称);
      not 测试用例.应该成功
  | 成功 (词法单元列表, _) ->
      (* 然后进行语法分析 *)
      匹配 语法分析 词法单元列表 "测试文件" 的
      | 失败 错误信息 ->
          let 结果 = not 测试用例.应该成功 在
          if 结果 then
            打印调试信息 ("测试通过: " ^ 测试用例.名称 ^ " (期望失败)")
          else
            打印调试信息 ("测试失败: " ^ 测试用例.名称 ^ " (意外失败)");
          结果
      | 成功 (程序, _) ->
          let 结果 = 测试用例.应该成功 在
          if 结果 then
            打印调试信息 ("测试通过: " ^ 测试用例.名称 ^ " (成功解析)")
          else
            打印调试信息 ("测试失败: " ^ 测试用例.名称 ^ " (意外成功)");
          结果

(* 运行所有语法测试 *)
让 运行所有语法测试 = 函数 () ->
  打印调试信息 "开始语法分析器测试...";
  
  let 通过数量 = ref 0 在
  let 总数量 = List.length 基础语法测试用例列表 在
  
  List.iter (函数 测试用例 ->
    if 运行语法测试用例 测试用例 then
      通过数量 := !通过数量 + 1
  ) 基础语法测试用例列表;
  
  打印调试信息 ("语法测试完成: " ^ 
                (整数转字符串 !通过数量) ^ "/" ^ 
                (整数转字符串 总数量) ^ " 测试通过");
  
  !通过数量 = 总数量

(* AST遍历测试 *)
让 测试AST遍历 = 函数 () ->
  打印调试信息 "测试AST遍历功能...";
  
  let 测试输入 = "1 + 2 * 3" 在
  
  匹配 词法分析 测试输入 "测试文件" 的
  | 失败 _ -> 
      打印调试信息 "AST遍历测试失败：词法分析错误";
      false
  | 成功 (词法单元列表, _) ->
      匹配 语法分析 词法单元列表 "测试文件" 的
      | 失败 _ ->
          打印调试信息 "AST遍历测试失败：语法分析错误";
          false
      | 成功 (程序, _) ->
          (* 简单验证程序结构 *)
          let 语句数量 = List.length 程序 在
          if 语句数量 > 0 then (
            打印调试信息 ("AST遍历测试通过：解析出 " ^ (整数转字符串 语句数量) ^ " 个语句");
            true
          ) else (
            打印调试信息 "AST遍历测试失败：没有解析出语句";
            false
          )

(* 主测试函数 *)
让 主函数 = 函数 () ->
  let 语法测试结果 = 运行所有语法测试 () 在
  let AST测试结果 = 测试AST遍历 () 在
  
  if 语法测试结果 && AST测试结果 then
    打印调试信息 "所有语法分析器测试通过！"
  else
    打印调试信息 "部分语法分析器测试失败！"