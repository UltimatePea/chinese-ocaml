（*
 * 符号表 - 符号表管理和作用域处理
 * 管理变量绑定、类型定义和函数签名
 *）

「：引入基础模块：」
使用 基础工具.工具库
使用 基础工具.位置信息
使用 基础工具.错误处理

「：符号类型：」
类型 符号类型=  | 变量符号 的 字符串 * 位置范围
  | 函数符号 的 字符串 * 字符串 列表 * 位置范围
  | 类型符号 的 字符串 * 位置范围
  | 构造器符号 的 字符串 * 字符串 * 位置范围

「：符号绑定：」
类型 符号绑定={
  名称: 字符串;
  符号类型: 符号类型;
  定义位置: 位置范围;
  可变: 布尔值;
}

「：作用域类型：」
类型 作用域={
  父作用域: 作用域 选项;
  绑定表: （字符串, 符号绑定） 字典;
  mutable 作用域级别: 整数;
}

「：符号表类型：」
类型 符号表={
  mutable 当前作用域: 作用域;
  mutable 全局作用域: 作用域;
  错误收集器: 错误收集器;
}

「：创建新作用域：」
夫「创建作用域」者受 父作用域 级别 焉算法乃
  {
    父作用域=父作用域;
    绑定表=创建字典 （）;
    作用域级别=级别;
  }
也

「：创建符号表：」
夫「创建符号表」者受 错误收集器 焉算法乃
  设「全局作用域」为创建作用域 无 0 在
  {
    当前作用域=全局作用域;
    全局作用域=全局作用域;
    错误收集器=错误收集器;
  }
也

「：进入新作用域：」
夫「进入作用域」者受 符号表 焉算法乃
  设「新级别」为符号表.当前作用域.作用域级别 + 1 在
  设「新作用域」为创建作用域 （有 符号表.当前作用域） 新级别 在
  符号表.当前作用域 :=新作用域
也

「：退出当前作用域：」
夫「退出作用域」者受 符号表 焉算法乃
  观「符号表.当前作用域.父作用域」之性
  | 无 ->
      添加编译错误 符号表.错误收集器
        （语义错误 （『无法退出全局作用域』, 创建初始位置 『』））
  | 有 父作用域 ->
      符号表.当前作用域 :=父作用域
  观毕
也

「：创建符号绑定：」
夫「创建符号绑定」者受 名称 符号类型 位置 可变 焉算法乃
  {
    名称=名称;
    符号类型=符号类型;
    定义位置=位置;
    可变=可变;
  }
也

「：在当前作用域中绑定符号：」
夫「绑定符号」者受 符号表 名称 符号类型 位置 可变 焉算法乃
  若 字典包含键 符号表.当前作用域.绑定表 名称 则 答 （
    添加编译错误 符号表.错误收集器
      （语义错误 （『符号 '』 ^ 名称 ^ 『' 已在当前作用域中定义』, 位置））;
    false
  ） 余者答 （
    设「绑定」为创建符号绑定 名称 符号类型 位置 可变 在
    字典添加 符号表.当前作用域.绑定表 名称 绑定;
    true
  ）
也

「：在当前作用域中查找符号：」
夫「在作用域中查找符号」者受 作用域 名称 焉算法乃
  若 字典包含键 作用域.绑定表 名称 则 答
    有 （字典获取 作用域.绑定表 名称）
  余者答
    无
也

「：递归查找符号（向上查找作用域链）：」
夫 递归 查找符号 者 受 符号表 名称 焉算法乃
  设 递归 查找为函数 作用域 ->
    观 在作用域中查找符号 作用域 名称 之 性
    | 有 绑定 -> 有 绑定
    | 无 ->
        观「作用域.父作用域」之性
        | 无 -> 无
        | 有 父作用域 -> 查找 父作用域
        观毕
    观毕 在
  查找 符号表.当前作用域
也

「：查找符号，如果不存在则报错：」
夫「查找符号或报错」者受 符号表 名称 位置 焉算法乃
  观 查找符号 符号表 名称 之 性
  | 有 绑定 -> 有 绑定
  | 无 ->
      添加编译错误 符号表.错误收集器
        （语义错误 （『未定义的符号 '』 ^ 名称 ^ 『'』, 位置））;
      无
  观毕
也

「：检查符号是否可变：」
夫「符号是否可变」者受 绑定 焉算法乃
  绑定.可变
也

「：获取符号类型：」
夫「获取符号类型」者受 绑定 焉算法乃
  绑定.符号类型
也

「：获取符号定义位置：」
夫「获取符号位置」者受 绑定 焉算法乃
  绑定.定义位置
也

「：列出当前作用域中的所有符号：」
夫「列出当前作用域符号」者受 符号表 焉算法乃
  字典键列表 符号表.当前作用域.绑定表
也

「：获取当前作用域级别：」
夫「获取作用域级别」者受 符号表 焉算法乃
  符号表.当前作用域.作用域级别
也

「：是否在全局作用域：」
夫「在全局作用域」者受 符号表 焉算法乃
  符号表.当前作用域.作用域级别=0
也

「：初始化全局符号表（预定义符号）：」
夫「初始化全局符号」者受 符号表 焉算法乃
  设「位置」为创建初始位置 『<内置>』 在

  「：添加内置类型：」
  忽略 （绑定符号 符号表 『整数』 （类型符号 （『整数』, 位置）） 位置 false）;
  忽略 （绑定符号 符号表 『浮点数』 （类型符号 （『浮点数』, 位置）） 位置 false）;
  忽略 （绑定符号 符号表 『字符串』 （类型符号 （『字符串』, 位置）） 位置 false）;
  忽略 （绑定符号 符号表 『布尔值』 （类型符号 （『布尔值』, 位置）） 位置 false）;
  忽略 （绑定符号 符号表 『单元』 （类型符号 （『单元』, 位置）） 位置 false）;

  「：添加内置函数：」
  忽略 （绑定符号 符号表 『打印』 （函数符号 （『打印』, (列开始 『字符串』 其一 列结束), 位置）） 位置 false）;
  忽略 （绑定符号 符号表 『打印整数』 （函数符号 （『打印整数』, (列开始 『整数』 其一 列结束), 位置）） 位置 false）;
  忽略 （绑定符号 符号表 『长度』 （函数符号 （『长度』, (列开始 『列表』 其一 列结束), 位置）） 位置 false）;

  「：添加内置值：」
  忽略 （绑定符号 符号表 『真』 （变量符号 （『真』, 位置）） 位置 false）;
  忽略 （绑定符号 符号表 『假』 （变量符号 （『假』, 位置）） 位置 false）
也

「：调试：打印作用域信息：」
夫「调试打印作用域」者受 符号表 焉算法乃
  设 递归 打印作用域为函数 作用域 缩进 ->
    打印字符串 （缩进 ^ 『作用域级别: 』 ^ （字符串化整数 作用域.作用域级别））;
    打印换行 （）;
    设「符号列表」为字典键列表 作用域.绑定表 在
    List.iter （函数 名称 ->
      设「绑定」为字典获取 作用域.绑定表 名称 在
      打印字符串 （缩进 ^ 『  』 ^ 名称 ^ 『: 』）;
      观「绑定.符号类型」之性
      | 变量符号 （类型, _） -> 打印字符串 （『变量 』 ^ 类型）
      | 函数符号 （返回类型, 参数类型, _） ->
          打印字符串 （『函数 （』 ^ （字符串连接 『, 』 参数类型） ^ 『 -> 』 ^ 返回类型 ^ 『）』）
      | 类型符号 （类型名, _） -> 打印字符串 （『类型 』 ^ 类型名）
      | 构造器符号 （构造器名, 类型名, _） ->
          打印字符串 （『构造器 』 ^ 构造器名 ^ 『 : 』 ^ 类型名）
      观毕;
      打印换行 （）;
    ） 符号列表;
    观「作用域.父作用域」之性
    | 无 -> （）
    | 有 父作用域 -> 打印作用域 父作用域 （『  』 ^ 缩进）
    观毕 在
  打印字符串 『符号表内容:』;
  打印换行 （）;
  打印作用域 符号表.当前作用域 『』
也