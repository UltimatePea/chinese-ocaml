（乘
 * 类型系统 - 类型检查和类型推导
 * 实现骆言语言的类型检查系统
 *）

「：引入基础模块：」
使用 基础工具点工具库
使用 基础工具点位置信息
使用 基础工具点错误处理
使用 基础工具点抽象语法树

「：类型变量计数器：」
设 可变 类型变量计数器为0

「：重置类型变量计数器：」
夫「重置类型变量计数器」者受 （） 焉算法乃
  类型变量计数器 ：等于0
也

「：生成新的类型变量：」
夫「生成类型变量」者受 （） 焉算法乃
  类型变量计数器 ：等于类型变量计数器 加 1；
  『项』 乘方 （字符串化整数 类型变量计数器）
也

「：内部类型表示：」
类型 内部类型等于  或 基础类型 的 字符串
  或 类型变量 的 字符串
  或 函数类型 的 内部类型 乘 内部类型
  或 元组类型 的 内部类型 列表
  或 列表类型 的 内部类型
  或 记录类型 的 （字符串 乘 内部类型） 列表
  或 变体类型 的 字符串 乘 内部类型 列表
  或 引用类型 的 内部类型
  或 数组类型 的 内部类型

「：类型约束：」
类型 类型约束等于内部类型 乘 内部类型

「：类型环境：」
类型 类型环境等于「
  变量类型： （字符串， 内部类型） 字典；
  类型定义： （字符串， 内部类型） 字典；
  类型约束： 类型约束 列表 参考；
」

「：创建类型环境：」
夫「创建类型环境」者受 （） 焉算法乃
  「
    变量类型等于创建字典 （）；
    类型定义等于创建字典 （）；
    类型约束等于参考 空空如也；
  」
也

「：复制类型环境：」
夫「复制类型环境」者受 环境 焉算法乃
  「
    变量类型等于复制字典 环境点变量类型；
    类型定义等于复制字典 环境点类型定义；
    类型约束等于参考 ！（环境点类型约束）；
  」
也

「：在类型环境中绑定变量类型：」
夫「绑定变量类型」者受 环境 变量名 类型 焉算法乃
  字典添加 环境点变量类型 变量名 类型
也

「：在类型环境中查找变量类型：」
夫「查找变量类型」者受 环境 变量名 焉算法乃
  若 字典包含键 环境点变量类型 变量名 则 答
    有 （字典获取 环境点变量类型 变量名）
  余者答
    无
也

「：添加类型约束：」
夫「添加类型约束」者受 环境 类型1 类型2 焉算法乃
  环境点类型约束 ：等于（类型1， 类型2） ：： ！（环境点类型约束）
也

「：类型相等检查：」
夫 递归 类型相等 者 受 类型1 类型2 焉算法乃
  观 （类型1， 类型2） 之 性
  或 （基础类型 名称1， 基础类型 名称2） 减大于 名称1等于名称2
  或 （类型变量 变量1， 类型变量 变量2） 减大于 变量1等于变量2
  或 （函数类型 （参数1， 返回1）， 函数类型 （参数2， 返回2）） 减大于
      类型相等 参数1 参数2 和和 类型相等 返回1 返回2
  或 （元组类型 类型列表1， 元组类型 类型列表2） 减大于
      List点长度 类型列表1等于List点长度 类型列表2 和和
      List点循环all2 类型相等 类型列表1 类型列表2
  或 （列表类型 元素类型1， 列表类型 元素类型2） 减大于
      类型相等 元素类型1 元素类型2
  或 （引用类型 内容类型1， 引用类型 内容类型2） 减大于
      类型相等 内容类型1 内容类型2
  或 （数组类型 元素类型1， 数组类型 元素类型2） 减大于
      类型相等 元素类型1 元素类型2
  或 下划线 减大于 假
  观毕
也

「：类型统一算法：」
夫 递归 统一类型 者 受 环境 类型1 类型2 焉算法乃
  若 类型相等 类型1 类型2 则 答
    成功 （）
  余者答
    观 （类型1， 类型2） 之 性
    或 （类型变量 变量， 类型） 或 （类型， 类型变量 变量） 减大于
        若 类型包含变量 类型 变量 则 答
          错误 （『循环类型约束： 』 乘方 变量 乘方 『 出现在 』 乘方 （格式化类型 类型））
        余者答 （
          添加类型约束 环境 （类型变量 变量） 类型；
          成功 （）
        ）
    或 （函数类型 （参数1， 返回1）， 函数类型 （参数2， 返回2）） 减大于
        观 统一类型 环境 参数1 参数2 之 性
        或 错误 信息 减大于 错误 信息
        或 成功 （） 减大于 统一类型 环境 返回1 返回2
        观毕
    或 （元组类型 类型列表1， 元组类型 类型列表2） 减大于
        若 List点长度 类型列表1 小于大于 List点长度 类型列表2 则 答
          错误 （『元组长度不匹配』）
        余者答
          统一类型列表 环境 类型列表1 类型列表2
    或 （列表类型 元素类型1， 列表类型 元素类型2） 减大于
        统一类型 环境 元素类型1 元素类型2
    或 （引用类型 内容类型1， 引用类型 内容类型2） 减大于
        统一类型 环境 内容类型1 内容类型2
    或 （数组类型 元素类型1， 数组类型 元素类型2） 减大于
        统一类型 环境 元素类型1 元素类型2
    或 下划线 减大于
        错误 （『无法统一类型： 』 乘方 （格式化类型 类型1） 乘方 『 和 』 乘方 （格式化类型 类型2））
    观毕
也

且有 统一类型列表 者 受 环境 类型列表1 类型列表2 焉算法乃
  观 （类型列表1， 类型列表2） 之 性
  或 （空空如也， 空空如也） 减大于 成功 （）
  或 （类型1 ：： 其余1， 类型2 ：： 其余2） 减大于
      观 统一类型 环境 类型1 类型2 之 性
      或 错误 信息 减大于 错误 信息
      或 成功 （） 减大于 统一类型列表 环境 其余1 其余2
      观毕
  或 下划线 减大于 错误 （『类型列表长度不匹配』）
  观毕
也

且有 类型包含变量 者 受 类型 变量 焉算法乃
  观「类型」之性
  或 基础类型 下划线 减大于 假
  或 类型变量 变量名 减大于 变量名等于变量
  或 函数类型 （参数类型， 返回类型） 减大于
      类型包含变量 参数类型 变量 或或 类型包含变量 返回类型 变量
  或 元组类型 类型列表 减大于
      List点存在 （夫「下划线」者受 类型 焉算法乃 类型包含变量 类型 变量 也） 类型列表
  或 列表类型 元素类型 减大于
      类型包含变量 元素类型 变量
  或 记录类型 字段列表 减大于
      List点存在 （夫「下划线」者受 （下划线， 类型） 焉算法乃 类型包含变量 类型 变量 也） 字段列表
  或 变体类型 （下划线， 参数类型列表） 减大于
      List点存在 （夫「下划线」者受 类型 焉算法乃 类型包含变量 类型 变量 也） 参数类型列表
  或 引用类型 内容类型 减大于
      类型包含变量 内容类型 变量
  或 数组类型 元素类型 减大于
      类型包含变量 元素类型 变量
  观毕
也

且有 格式化类型 者 受 类型 焉算法乃
  观「类型」之性
  或 基础类型 名称 减大于 名称
  或 类型变量 变量 减大于 『『』 乘方 变量
  或 函数类型 （参数类型， 返回类型） 减大于
      『（』 乘方 （格式化类型 参数类型） 乘方 『 减大于 』 乘方 （格式化类型 返回类型） 乘方 『）』
  或 元组类型 类型列表 减大于
      『（』 乘方 （字符串连接 『 乘 』 （List点映射 格式化类型 类型列表）） 乘方 『）』
  或 列表类型 元素类型 减大于
      （格式化类型 元素类型） 乘方 『 列表』
  或 记录类型 字段列表 减大于
      『「 』 乘方 （字符串连接 『； 』 （List点映射 （夫「下划线」者受 （名称， 类型） 焉算法乃
        名称 乘方 『： 』 乘方 （格式化类型 类型） 也） 字段列表）） 乘方 『 」』
  或 变体类型 （名称， 参数类型列表） 减大于
      名称 乘方 （若 参数类型列表等于空空如也 则 答 『』
              余者答 『 （』 乘方 （字符串连接 『 乘 』 （List点映射 格式化类型 参数类型列表）） 乘方 『）』）
  或 引用类型 内容类型 减大于
      （格式化类型 内容类型） 乘方 『 引用』
  或 数组类型 元素类型 减大于
      （格式化类型 元素类型） 乘方 『 数组』
  观毕
也

「：从类型表达式转换为内部类型：」
夫 递归 类型表达式到内部类型 者 受 环境 类型表达式 焉算法乃
  观「类型表达式」之性
  或 基础类型 （名称， 下划线） 减大于 基础类型 名称
  或 类型变量 （变量， 下划线） 减大于 类型变量 变量
  或 函数类型 （参数类型， 返回类型， 下划线） 减大于
      设「参数」为类型表达式到内部类型 环境 参数类型 在
      设「返回」为类型表达式到内部类型 环境 返回类型 在
      函数类型 （参数， 返回）
  或 元组类型 （类型列表， 下划线） 减大于
      设「内部类型列表」为List点映射 （类型表达式到内部类型 环境） 类型列表 在
      元组类型 内部类型列表
  或 列表类型 （元素类型， 下划线） 减大于
      设「元素」为类型表达式到内部类型 环境 元素类型 在
      列表类型 元素
  或 记录类型 （字段列表， 下划线） 减大于
      设「内部字段列表」为List点映射 （夫「下划线」者受 （名称， 类型） 焉算法乃
        （名称， 类型表达式到内部类型 环境 类型） 也） 字段列表 在
      记录类型 内部字段列表
  或 变体类型 （名称， 参数类型列表， 下划线） 减大于
      设「内部参数类型列表」为List点映射 （类型表达式到内部类型 环境） 参数类型列表 在
      变体类型 （名称， 内部参数类型列表）
  或 引用类型 （内容类型， 下划线） 减大于
      设「内容」为类型表达式到内部类型 环境 内容类型 在
      引用类型 内容
  或 数组类型 （元素类型， 下划线） 减大于
      设「元素」为类型表达式到内部类型 环境 元素类型 在
      数组类型 元素
  观毕
也

「：推导字面量类型：」
夫「推导字面量类型」者受 字面量 焉算法乃
  观「字面量」之性
  或 整数字面量 下划线 减大于 基础类型 『整数』
  或 浮点字面量 下划线 减大于 基础类型 『浮点数』
  或 字符串字面量 下划线 减大于 基础类型 『字符串』
  或 布尔字面量 下划线 减大于 基础类型 『布尔值』
  或 单元字面量 减大于 基础类型 『单元』
  观毕
也

「：推导二元运算类型：」
夫「推导二元运算类型」者受 运算符 左类型 右类型 焉算法乃
  观「运算符」之性
  或 加法 或 减法 或 乘法 或 除法 或 模运算 减大于
      若 类型相等 左类型 （基础类型 『整数』） 和和 类型相等 右类型 （基础类型 『整数』） 则 答
        成功 （基础类型 『整数』）
      余者 若 类型相等 左类型 （基础类型 『浮点数』） 和和 类型相等 右类型 （基础类型 『浮点数』） 则 答
        成功 （基础类型 『浮点数』）
      余者答
        错误 （『算术运算要求数值类型』）
  或 等于 或 不等于 减大于
      若 类型相等 左类型 右类型 则 答
        成功 （基础类型 『布尔值』）
      余者答
        错误 （『相等比较要求相同类型』）
  或 小于 或 小于等于 或 大于 或 大于等于 减大于
      若 （类型相等 左类型 （基础类型 『整数』） 和和 类型相等 右类型 （基础类型 『整数』）） 或或
         （类型相等 左类型 （基础类型 『浮点数』） 和和 类型相等 右类型 （基础类型 『浮点数』）） 则 答
        成功 （基础类型 『布尔值』）
      余者答
        错误 （『数值比较要求数值类型』）
  或 逻辑与 或 逻辑或 减大于
      若 类型相等 左类型 （基础类型 『布尔值』） 和和 类型相等 右类型 （基础类型 『布尔值』） 则 答
        成功 （基础类型 『布尔值』）
      余者答
        错误 （『逻辑运算要求布尔类型』）
  或 字符串连接 减大于
      若 类型相等 左类型 （基础类型 『字符串』） 和和 类型相等 右类型 （基础类型 『字符串』） 则 答
        成功 （基础类型 『字符串』）
      余者答
        错误 （『字符串连接要求字符串类型』）
  观毕
也

「：推导一元运算类型：」
夫「推导一元运算类型」者受 运算符 操作数类型 焉算法乃
  观「运算符」之性
  或 逻辑非 减大于
      若 类型相等 操作数类型 （基础类型 『布尔值』） 则 答
        成功 （基础类型 『布尔值』）
      余者答
        错误 （『逻辑非运算要求布尔类型』）
  或 数值取反 减大于
      若 类型相等 操作数类型 （基础类型 『整数』） 则 答
        成功 （基础类型 『整数』）
      余者 若 类型相等 操作数类型 （基础类型 『浮点数』） 则 答
        成功 （基础类型 『浮点数』）
      余者答
        错误 （『数值取反要求数值类型』）
  观毕
也

「：初始化基础类型环境：」
夫「初始化基础类型环境」者受 环境 焉算法乃
  字典添加 环境点类型定义 『整数』 （基础类型 『整数』）；
  字典添加 环境点类型定义 『浮点数』 （基础类型 『浮点数』）；
  字典添加 环境点类型定义 『字符串』 （基础类型 『字符串』）；
  字典添加 环境点类型定义 『布尔值』 （基础类型 『布尔值』）；
  字典添加 环境点类型定义 『单元』 （基础类型 『单元』）
也