(*
 * 错误处理模块
 * 定义编译器的各种错误类型和错误报告机制
 *)

「：引入位置信息：」
使用 位置信息

「：错误严重程度：」
类型 错误级别 =
  | 警告
  | 错误
  | 致命错误

「：编译错误类型：」
类型 编译错误 =
  | 词法错误 的 字符串 * 位置
  | 语法错误 的 字符串 * 位置范围
  | 语义错误 的 字符串 * 位置范围
  | 类型错误 的 字符串 * 位置范围
  | 代码生成错误 的 字符串 * 位置范围
  | 文件错误 的 字符串 * 字符串  「：错误信息 * 文件路径：」
  | 内部错误 的 字符串

「：错误收集器类型：」
类型 错误收集器 = {
  mutable 错误列表: (错误级别 * 编译错误) 列表;
  mutable 警告计数: 整数;
  mutable 错误计数: 整数;
}

「：创建错误收集器：」
夫 创建错误收集器 者 受 () 焉 算法 乃 {
  错误列表 = [];
  警告计数 = 0;
  错误计数 = 0;
} 是谓

「：添加错误：」
夫 添加错误 者 受 收集器 级别 错误 焉 算法 乃
  收集器.错误列表 := (级别, 错误) :: 收集器.错误列表;
  观 级别 之 性
  | 警告 -> 收集器.警告计数 := 收集器.警告计数 + 1
  | 错误 | 致命错误 -> 收集器.错误计数 := 收集器.错误计数 + 1
  观毕
是谓

「：添加警告的便捷函数：」
夫 添加警告 者 受 收集器 错误 焉 算法 乃
  添加错误 收集器 警告 错误
是谓

「：添加错误的便捷函数：」
夫 添加编译错误 者 受 收集器 错误 焉 算法 乃
  添加错误 收集器 错误 错误
是谓

「：添加致命错误的便捷函数：」
夫 添加致命错误 者 受 收集器 错误 焉 算法 乃
  添加错误 收集器 致命错误 错误
是谓

「：检查是否有错误：」
夫 有错误 者 受 收集器 焉 算法 乃
  收集器.错误计数 > 0
是谓

「：检查是否有警告：」
夫 有警告 者 受 收集器 焉 算法 乃
  收集器.警告计数 > 0
是谓

「：获取错误统计：」
夫 错误统计 者 受 收集器 焉 算法 乃
  (收集器.警告计数, 收集器.错误计数)
是谓

「：清空错误列表：」
夫 清空错误 者 受 收集器 焉 算法 乃
  收集器.错误列表 := [];
  收集器.警告计数 := 0;
  收集器.错误计数 := 0
是谓

「：格式化错误级别：」
夫 格式化错误级别 者 受 级别 焉 算法 乃
  观 级别 之 性
  | 警告 -> 『警告』
  | 错误 -> 『错误』
  | 致命错误 -> 『致命错误』
  观毕
是谓

「：格式化编译错误：」
夫 格式化编译错误 者 受 错误 焉 算法 乃
  观 错误 之 性
  | 词法错误 (消息, 位置) ->
      『词法错误: 』 ^ 消息 ^ 『 在 』 ^ (格式化位置 位置)
  | 语法错误 (消息, 范围) ->
      『语法错误: 』 ^ 消息 ^ 『 在 』 ^ (格式化位置范围 范围)
  | 语义错误 (消息, 范围) ->
      『语义错误: 』 ^ 消息 ^ 『 在 』 ^ (格式化位置范围 范围)
  | 类型错误 (消息, 范围) ->
      『类型错误: 』 ^ 消息 ^ 『 在 』 ^ (格式化位置范围 范围)
  | 代码生成错误 (消息, 范围) ->
      『代码生成错误: 』 ^ 消息 ^ 『 在 』 ^ (格式化位置范围 范围)
  | 文件错误 (消息, 文件路径) ->
      『文件错误: 』 ^ 消息 ^ 『 文件: 』 ^ 文件路径
  | 内部错误 消息 ->
      『内部错误: 』 ^ 消息
  观毕
是谓

「：格式化完整错误信息：」
夫 格式化完整错误 者 受 级别 错误 焉 算法 乃
  『[』 ^ (格式化错误级别 级别) ^ 『] 』 ^ (格式化编译错误 错误)
是谓

「：打印错误：」
夫 打印错误 者 受 级别 错误 焉 算法 乃
  打印 (格式化完整错误 级别 错误)
是谓

「：打印所有错误：」
夫 打印所有错误 者 受 收集器 焉 算法 乃
  设 错误列表 为 List.rev 收集器.错误列表 在
  List.iter (夫 者 受 (级别, 错误) 焉 算法 乃 打印错误 级别 错误 是谓) 错误列表
是谓

「：返回所有错误的字符串列表：」
夫 获取所有错误字符串 者 受 收集器 焉 算法 乃
  设 错误列表 为 List.rev 收集器.错误列表 在
  List.map (夫 者 受 (级别, 错误) 焉 算法 乃 格式化完整错误 级别 错误 是谓) 错误列表
是谓

「：错误结果类型 - 集成错误收集器：」
类型 编译结果 T = {
  结果: T 选项;
  错误收集器: 错误收集器;
}

「：创建成功结果：」
夫 创建成功结果 者 受 值 收集器 焉 算法 乃 {
  结果 = 有 值;
  错误收集器 = 收集器;
} 是谓

「：创建失败结果：」
夫 创建失败结果 者 受 收集器 焉 算法 乃 {
  结果 = 无;
  错误收集器 = 收集器;
} 是谓

「：检查编译结果是否成功：」
夫 编译成功 者 受 结果 焉 算法 乃
  观 结果.结果 之 性
  | 有 _ -> not (有错误 结果.错误收集器)
  | 无 -> false
  观毕
是谓

「：提取编译结果的值：」
夫 提取结果值 者 受 结果 焉 算法 乃
  结果.结果
是谓

「：合并编译结果的错误收集器：」
夫 合并错误收集器 者 受 收集器1 收集器2 焉 算法 乃
  设 新收集器 为 创建错误收集器 () 在
  List.iter (夫 者 受 (级别, 错误) 焉 算法 乃 添加错误 新收集器 级别 错误 是谓) 收集器1.错误列表;
  List.iter (夫 者 受 (级别, 错误) 焉 算法 乃 添加错误 新收集器 级别 错误 是谓) 收集器2.错误列表;
  新收集器
是谓