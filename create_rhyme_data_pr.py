#!/usr/bin/env python3
"""
åˆ›å»ºéŸµå¾‹æ•°æ®å¤–åŒ–æŠ€æœ¯å€ºåŠ¡æ”¹è¿›Pull Request
"""

import sys
sys.path.append('.')
from github_auth import get_installation_token
import requests
import json

def create_rhyme_data_pr():
    """åˆ›å»ºéŸµå¾‹æ•°æ®å¤–åŒ–æ”¹è¿›PR"""
    
    title = "æŠ€æœ¯å€ºåŠ¡æ”¹è¿›ï¼šéŸµå¾‹æ•°æ®å¤–åŒ–é‡æ„å®Œæˆ Fix #728"
    
    body = """## ğŸ“‹ æ”¹è¿›æ¦‚è¿°

æœ¬PRæˆåŠŸå®ŒæˆéŸµå¾‹æ•°æ®å¤–åŒ–é‡æ„ï¼Œè§£å†³Issue #728ä¸­è¯†åˆ«çš„æŠ€æœ¯å€ºåŠ¡é—®é¢˜ã€‚å°†`src/poetry/unified_rhyme_data.ml`ä¸­374è¡Œç¡¬ç¼–ç æ•°æ®è½¬æ¢ä¸ºJSONé…ç½®é©±åŠ¨çš„æ¨¡å—åŒ–æ¶æ„ã€‚

## ğŸ¯ ä¸»è¦æˆæœ

### ä»£ç é‡æ˜¾è‘—å‡å°‘
- **é‡æ„å‰**: 374è¡Œä»£ç 
- **é‡æ„å**: 122è¡Œä»£ç   
- **å‡å°‘**: 252è¡Œ (67.4% æ”¹å–„)

### æ•°æ®å¤–åŒ–æˆåŠŸ
- âœ… åˆ›å»ºJSONé…ç½®æ–‡ä»¶: `data/poetry/rhyme_groups/rhyme_groups_data.json`
- âœ… åŒ…å«9ä¸ªéŸµå¾‹ç»„çš„å®Œæ•´ç»“æ„åŒ–æ•°æ®
- âœ… æ”¯æŒé…ç½®é©±åŠ¨çš„éŸµå¾‹æ•°æ®ç®¡ç†

### æ¶æ„å‡çº§
- âœ… æ•°æ®ä¸é€»è¾‘å®Œå…¨åˆ†ç¦»
- âœ… å®ç°æ•°æ®ç¼“å­˜æœºåˆ¶æå‡æ€§èƒ½
- âœ… æ·»åŠ å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥
- âœ… ä¿æŒ100%ç°æœ‰æ¥å£å…¼å®¹æ€§

## ğŸ”§ æŠ€æœ¯å®æ–½ç»†èŠ‚

### é‡æ„ç­–ç•¥
1. **æ•°æ®å¤–åŒ–**: ç¡¬ç¼–ç éŸµå¾‹æ•°æ® â†’ JSONé…ç½®æ–‡ä»¶
2. **æ¨¡å—åŒ–**: å•ä¸€å¤§æ–‡ä»¶ â†’ åŠŸèƒ½æ¨¡å—åˆ†ç¦»
3. **å®¹é”™æœºåˆ¶**: é™æ€æ•°æ® â†’ åŠ¨æ€åŠ è½½+é™çº§ç­–ç•¥
4. **æ€§èƒ½ä¼˜åŒ–**: ç›´æ¥è®¿é—® â†’ ç¼“å­˜æœºåˆ¶

### JSONæ•°æ®ç»“æ„
```json
{
  "rhyme_groups": {
    "an_rhyme": {
      "name": "å®‰éŸµç»„",
      "category": "å¹³å£°", 
      "characters": ["å®‰", "å¹²", "çœ‹", "å±±", ...]
    }
  }
}
```

### é™çº§ç­–ç•¥
- å½“JSONæ–‡ä»¶ä¸å­˜åœ¨æ—¶â†’ä½¿ç”¨ç²¾ç®€å†…ç½®æ•°æ®
- å½“è§£æå¤±è´¥æ—¶â†’æä¾›åŸºæœ¬éŸµå¾‹æ•°æ®ä¿éšœ
- ç¡®ä¿ç³»ç»Ÿåœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½æ­£å¸¸è¿è¡Œ

## ğŸ“Š è´¨é‡éªŒè¯

### æ„å»ºå’Œæµ‹è¯•
- âœ… **ç¼–è¯‘**: æ— è­¦å‘Šæ— é”™è¯¯é€šè¿‡
- âœ… **æµ‹è¯•**: å…¨éƒ¨290+æµ‹è¯•ç”¨ä¾‹é€šè¿‡  
- âœ… **å…¼å®¹æ€§**: æ‰€æœ‰ç°æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… **æ€§èƒ½**: æ— æ€§èƒ½å›å½’

### ä»£ç è´¨é‡æŒ‡æ ‡
- âœ… **å¯ç»´æŠ¤æ€§**: æ•°æ®ä¸é€»è¾‘åˆ†ç¦»ï¼Œæ˜“äºç»´æŠ¤
- âœ… **å¯æ‰©å±•æ€§**: æ–°éŸµå¾‹ç»„å¯é€šè¿‡JSONé…ç½®æ·»åŠ 
- âœ… **å¥å£®æ€§**: å®Œæ•´é”™è¯¯å¤„ç†ï¼Œå¢å¼ºç³»ç»Ÿç¨³å®šæ€§

## ğŸ—ï¸ é‡æ„æ¨¡å¼

æœ¬æ¬¡é‡æ„éµå¾ªé¡¹ç›®å·²éªŒè¯çš„æœ€ä½³å®è·µæ¨¡å¼ï¼š

1. **æ•°æ®å¤–åŒ–æ¨¡å¼**: å‚è€ƒIssue #639 `expanded_data_loader.ml`æˆåŠŸé‡æ„
2. **æ¸è¿›å¼æ”¹è¿›**: ä¿æŒç°æœ‰æ¥å£å®Œå…¨å…¼å®¹
3. **æµ‹è¯•é©±åŠ¨**: ç¡®ä¿æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
4. **æ–‡æ¡£å®Œå–„**: è¯¦ç»†è®°å½•é‡æ„è¿‡ç¨‹å’Œå†³ç­–

## ğŸ“ˆ é¡¹ç›®ä»·å€¼

### ç«‹å³æ”¶ç›Š
- **æŠ€æœ¯å€ºåŠ¡å‡å°‘**: å¤§æ–‡ä»¶é—®é¢˜è§£å†³ï¼Œä»£ç æ›´æ¸…æ™°
- **ç»´æŠ¤æˆæœ¬é™ä½**: éŸµå¾‹æ•°æ®æ›´æ–°æ— éœ€é‡æ–°ç¼–è¯‘
- **å¼€å‘æ•ˆç‡æå‡**: æ•°æ®é…ç½®åŒ–ï¼Œä¾¿äºæ‰©å±•å’Œè°ƒè¯•

### é•¿æœŸä»·å€¼
- **å¯æ‰©å±•æ€§å¢å¼º**: æ–°éŸµå¾‹ç»„è½»æ¾æ·»åŠ 
- **ç³»ç»Ÿç¨³å®šæ€§**: é”™è¯¯å¤„ç†æœºåˆ¶å¢å¼ºç³»ç»Ÿå¯é æ€§
- **æ¨¡å¼å¯å¤ç”¨**: ä¸ºå…¶ä»–æ¨¡å—çš„ç±»ä¼¼é‡æ„æä¾›å‚è€ƒ

## ğŸ” æ–‡ä»¶å˜æ›´

### æ–°å¢æ–‡ä»¶
- `data/poetry/rhyme_groups/rhyme_groups_data.json` - éŸµå¾‹æ•°æ®é…ç½®
- `doc/change_log/0054-rhyme-data-externalization-fix-728.md` - é‡æ„æ–‡æ¡£

### ä¿®æ”¹æ–‡ä»¶
- `src/poetry/unified_rhyme_data.ml` - é‡æ„ä¸ºæ•°æ®åŠ è½½å™¨ï¼ˆ374â†’122è¡Œï¼‰

### å·¥å…·æ–‡ä»¶
- åˆ›å»ºIssueå’ŒPRçš„è‡ªåŠ¨åŒ–è„šæœ¬

## ğŸ§ª æµ‹è¯•éªŒè¯

```bash
# æ„å»ºéªŒè¯
dune build  # âœ… æ— è­¦å‘Šæ— é”™è¯¯

# æµ‹è¯•éªŒè¯  
dune runtest  # âœ… å…¨éƒ¨290+æµ‹è¯•é€šè¿‡

# åŠŸèƒ½éªŒè¯
# âœ… éŸµå¾‹åˆ†æåŠŸèƒ½æ­£å¸¸
# âœ… è¯—è¯è¯„ä»·åŠŸèƒ½æ­£å¸¸
# âœ… æ•°æ®åŠ è½½ç¼“å­˜æ­£å¸¸
```

## ğŸš€ éƒ¨ç½²å‡†å¤‡

- [x] ä»£ç æ„å»ºæ— é”™è¯¯
- [x] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [x] ç°æœ‰åŠŸèƒ½å…¼å®¹
- [x] æ–‡æ¡£æ›´æ–°å®Œæˆ
- [x] å˜æ›´æ—¥å¿—è®°å½•

## ğŸ“‹ éªŒæ”¶æ ‡å‡†

- [x] ä»£ç è¡Œæ•°å‡å°‘>50% (å®é™…67.4%)
- [x] æ‰€æœ‰ç°æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [x] æ„å»ºå’Œæµ‹è¯•é€šè¿‡
- [x] æ”¯æŒJSONé…ç½®æ•°æ®
- [x] å®Œæ•´é”™è¯¯å¤„ç†æœºåˆ¶
- [x] æ€§èƒ½æ— å›å½’

## ğŸ”„ åç»­è®¡åˆ’

æ­¤é‡æ„ä¸ºåç»­æ”¹è¿›å¥ å®šåŸºç¡€ï¼š

1. **çŸ­æœŸ**: å¯æ·»åŠ æ›´å®Œå–„çš„JSONè§£æåº“
2. **ä¸­æœŸ**: ç»Ÿä¸€é¡¹ç›®é…ç½®æ–‡ä»¶ç®¡ç†æ¨¡å¼
3. **é•¿æœŸ**: æ‰©å±•åˆ°æ›´å¤§çš„éŸµå¾‹æ•°æ®é›†

---

**å½±å“è¯„ä¼°**: è¿™æ˜¯ä¸€ä¸ªçº¯æŠ€æœ¯å€ºåŠ¡ä¿®å¤å’Œä»£ç è´¨é‡æ”¹è¿›ï¼Œ**æ— æ–°åŠŸèƒ½æ·»åŠ **ï¼Œç¬¦åˆé¡¹ç›®ç»´æŠ¤å‡†åˆ™ã€‚æ ¹æ®CLAUDE.mdæŒ‡å¯¼åŸåˆ™ï¼Œæ­¤ç±»çº¯æŠ€æœ¯å€ºåŠ¡ä¿®å¤åœ¨CIé€šè¿‡åå¯ä»¥åˆå¹¶ã€‚

**å‚è€ƒ**: Issue #639 ç±»ä¼¼çš„æ•°æ®å¤–åŒ–é‡æ„æˆåŠŸæ¡ˆä¾‹

Fix #728

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"""

    try:
        token = get_installation_token()
        
        headers = {
            'Authorization': f'token {token}',
            'Accept': 'application/vnd.github+json'
        }
        
        data = {
            'title': title,
            'head': 'rhyme-data-externalization-fix-728',
            'base': 'main',
            'body': body,
            'draft': False
        }
        
        url = 'https://api.github.com/repos/UltimatePea/chinese-ocaml/pulls'
        response = requests.post(url, headers=headers, json=data)
        
        if response.status_code == 201:
            pr_data = response.json()
            print(f"âœ… Pull Requeståˆ›å»ºæˆåŠŸï¼")
            print(f"PRç¼–å·: #{pr_data['number']}")
            print(f"æ ‡é¢˜: {pr_data['title']}")
            print(f"URL: {pr_data['html_url']}")
            return pr_data['number']
        else:
            print(f"âŒ PRåˆ›å»ºå¤±è´¥:")
            print(f"çŠ¶æ€ç : {response.status_code}")
            print(f"å“åº”: {response.text}")
            return None
            
    except Exception as e:
        print(f"âŒ åˆ›å»ºPRæ—¶å‘ç”Ÿé”™è¯¯: {e}")
        return None

if __name__ == '__main__':
    pr_number = create_rhyme_data_pr()
    if pr_number:
        print(f"\nğŸ‰ æŠ€æœ¯å€ºåŠ¡æ”¹è¿›å®Œæˆï¼PR #{pr_number} å·²åˆ›å»ºï¼Œç­‰å¾…CIéªŒè¯å’Œç»´æŠ¤è€…å®¡æ ¸ã€‚")