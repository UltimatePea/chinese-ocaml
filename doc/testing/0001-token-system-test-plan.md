# ğŸ§ª Tokenç³»ç»Ÿæ•´åˆæµ‹è¯•æ€»ä½“è§„åˆ’

**ä½œè€…**: Echo, æµ‹è¯•å·¥ç¨‹å¸ˆ  
**åˆ›å»ºæ—¥æœŸ**: 2025-07-26  
**ç‰ˆæœ¬**: 1.0  
**ç›¸å…³Issue**: #1357, #1355  
**ç›¸å…³PR**: #1356  

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æœ¬æ–‡æ¡£å®šä¹‰äº†éª†è¨€ç¼–è¯‘å™¨Tokenç³»ç»Ÿæ•´åˆé¡¹ç›®çš„å…¨é¢æµ‹è¯•ç­–ç•¥ï¼Œæ—¨åœ¨è§£å†³Deltaä¸“å‘˜åœ¨Issue #1357ä¸­æå‡ºçš„å…³é”®æµ‹è¯•è¦†ç›–ç‡ä¸è¶³é—®é¢˜ã€‚æµ‹è¯•è®¡åˆ’åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼Œç¡®ä¿Tokenç³»ç»Ÿçš„å…¼å®¹æ€§ã€åŠŸèƒ½å®Œæ•´æ€§å’Œæ€§èƒ½è¡¨ç°ã€‚

## ğŸ¯ æµ‹è¯•ç›®æ ‡

### ä¸»è¦ç›®æ ‡
1. **å…¼å®¹æ€§ä¿è¯**: ç¡®ä¿legacy Tokenç³»ç»Ÿå‘æ–°ç»Ÿä¸€Tokenç³»ç»Ÿçš„å¹³æ»‘è¿ç§»
2. **åŠŸèƒ½å®Œæ•´æ€§**: éªŒè¯æ‰€æœ‰Tokenç±»å‹å’Œè½¬æ¢å‡½æ•°çš„æ­£ç¡®æ€§
3. **æ€§èƒ½éªŒè¯**: è¯æ˜å£°ç§°çš„O(n)â†’O(1)æ€§èƒ½ä¼˜åŒ–æ•ˆæœ
4. **å›å½’é¢„é˜²**: å»ºç«‹å…¨é¢çš„å›å½’æµ‹è¯•å¥—ä»¶é˜²æ­¢åŠŸèƒ½å›é€€

### è´¨é‡æ ‡å‡†
- **æµ‹è¯•è¦†ç›–ç‡**: â‰¥90%
- **å…¼å®¹æ€§æµ‹è¯•è¦†ç›–**: â‰¥95%
- **æ€§èƒ½åŸºå‡†ä¿æŒ**: â‰¥90%åŸºçº¿
- **å›å½’æµ‹è¯•é€šè¿‡ç‡**: 100%

## ğŸ—ï¸ æµ‹è¯•æ¶æ„

### åˆ†å±‚æµ‹è¯•ç­–ç•¥
```
Level 4: ç«¯åˆ°ç«¯æµ‹è¯• (E2E)
â”œâ”€â”€ ç¼–è¯‘å™¨ç®¡é“é›†æˆæµ‹è¯•
â”œâ”€â”€ æ€§èƒ½åŸºå‡†æµ‹è¯•
â””â”€â”€ ç”¨æˆ·åœºæ™¯æµ‹è¯•

Level 3: é›†æˆæµ‹è¯• (Integration)
â”œâ”€â”€ Tokenç³»ç»Ÿæ¨¡å—é—´é›†æˆ
â”œâ”€â”€ å…¼å®¹æ€§æ¡¥æ¥é›†æˆ
â””â”€â”€ è§£æå™¨Tokenæµé›†æˆ

Level 2: ç»„ä»¶æµ‹è¯• (Component)
â”œâ”€â”€ Tokenè½¬æ¢å™¨æµ‹è¯•
â”œâ”€â”€ Tokenç±»åˆ«æ£€æŸ¥æµ‹è¯•
â””â”€â”€ Tokenå·¥å…·å‡½æ•°æµ‹è¯•

Level 1: å•å…ƒæµ‹è¯• (Unit)
â”œâ”€â”€ åŸºç¡€ç±»å‹è½¬æ¢æµ‹è¯•
â”œâ”€â”€ Tokenæ„é€ å‡½æ•°æµ‹è¯•
â””â”€â”€ ä½ç½®ä¿¡æ¯å¤„ç†æµ‹è¯•
```

## ğŸ“Š Phase T1: ç´§æ€¥æµ‹è¯•è¦†ç›– (3-4å¤©)

### ç›®æ ‡
å»ºç«‹critical pathçš„æµ‹è¯•è¦†ç›–ï¼Œè§£å†³æœ€ç´§æ€¥çš„æµ‹è¯•ç¼ºå¤±é—®é¢˜ã€‚

### æ ¸å¿ƒä»»åŠ¡

#### T1.1: Legacy Type Bridgeæµ‹è¯•å¥—ä»¶
- **æ–‡ä»¶**: `test/unit/test_legacy_type_bridge_comprehensive.ml`
- **è¦†ç›–èŒƒå›´**: 
  - 25ä¸ªåŸºç¡€è½¬æ¢å‡½æ•°
  - 6ä¸ªTokenæ„é€ å‡½æ•°
  - 8ä¸ªTokenç±»åˆ«æ£€æŸ¥å‡½æ•°
  - 4ä¸ªè°ƒè¯•å·¥å…·å‡½æ•°
- **æµ‹è¯•ç±»å‹**: å•å…ƒæµ‹è¯• + è¾¹ç•Œæ¡ä»¶æµ‹è¯•

#### T1.2: Tokenå…¼å®¹æ€§éªŒè¯
- **æ–‡ä»¶**: `test/integration/test_token_compatibility_integration.ml`
- **è¦†ç›–èŒƒå›´**:
  - Legacyâ†’æ–°ç³»ç»Ÿè½¬æ¢éªŒè¯
  - å¾€è¿”è½¬æ¢ä¸€è‡´æ€§æµ‹è¯•
  - ç±»å‹å®‰å…¨æ€§éªŒè¯
- **æµ‹è¯•ç±»å‹**: é›†æˆæµ‹è¯•

#### T1.3: è‡ªåŠ¨åŒ–æµ‹è¯•åŸºç¡€è®¾æ–½
- **CIé›†æˆ**: æ·»åŠ æµ‹è¯•åˆ°duneé…ç½®
- **æµ‹è¯•å·¥å…·**: åˆ›å»ºæµ‹è¯•è¾…åŠ©å·¥å…·
- **æŠ¥å‘Šç”Ÿæˆ**: è¦†ç›–ç‡æŠ¥å‘Šè‡ªåŠ¨ç”Ÿæˆ

### éªŒæ”¶æ ‡å‡†
- [ ] Legacy bridgeæµ‹è¯•è¦†ç›–ç‡â‰¥95%
- [ ] æ‰€æœ‰è½¬æ¢å‡½æ•°ç»è¿‡éªŒè¯
- [ ] CIä¸­è‡ªåŠ¨è¿è¡Œæµ‹è¯•å¥—ä»¶

## ğŸ“ˆ Phase T2: ç³»ç»Ÿæ€§æµ‹è¯•å»ºè®¾ (5-7å¤©)

### ç›®æ ‡
å»ºç«‹å…¨é¢çš„Tokenç³»ç»Ÿæµ‹è¯•è¦†ç›–ï¼Œç¡®ä¿æ•´åˆåçš„ç³»ç»Ÿç¨³å®šæ€§ã€‚

### æ ¸å¿ƒä»»åŠ¡

#### T2.1: ç»Ÿä¸€Tokenç³»ç»Ÿé›†æˆæµ‹è¯•
- **æ–‡ä»¶**: `test/integration/test_unified_token_system.ml`
- **è¦†ç›–èŒƒå›´**:
  - 12ç§Tokenç±»å‹çš„å®Œæ•´æµ‹è¯•
  - Tokenæµå¤„ç†æµ‹è¯•
  - è§£æå™¨é›†æˆæµ‹è¯•
- **æµ‹è¯•ç±»å‹**: é›†æˆæµ‹è¯•

#### T2.2: Tokenåˆ†ç±»å’Œå·¥å…·æµ‹è¯•
- **æ–‡ä»¶**: `test/unit/test_token_utilities_comprehensive.ml`
- **è¦†ç›–èŒƒå›´**:
  - Tokenç±»åˆ«åˆ†ç±»æµ‹è¯•
  - ä¼˜å…ˆçº§å’Œå…³è”æ€§æµ‹è¯•
  - æ‰¹é‡å¤„ç†å·¥å…·æµ‹è¯•
- **æµ‹è¯•ç±»å‹**: å•å…ƒæµ‹è¯•

#### T2.3: é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæ¡ä»¶
- **æ–‡ä»¶**: `test/unit/test_token_error_handling.ml`
- **è¦†ç›–èŒƒå›´**:
  - éæ³•è¾“å…¥å¤„ç†
  - è¾¹ç•Œæ¡ä»¶æµ‹è¯•
  - å¼‚å¸¸æƒ…å†µå¤„ç†
- **æµ‹è¯•ç±»å‹**: å•å…ƒæµ‹è¯• + è´Ÿé¢æµ‹è¯•

### éªŒæ”¶æ ‡å‡†
- [ ] Tokenç³»ç»Ÿæ•´ä½“æµ‹è¯•è¦†ç›–ç‡â‰¥90%
- [ ] æ‰€æœ‰12ç§Tokenç±»å‹ç»è¿‡æµ‹è¯•
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶éªŒè¯å®Œæ¯•

## âš¡ Phase T3: æ€§èƒ½ä¸è´¨é‡åŸºçº¿ (3-4å¤©)

### ç›®æ ‡
å»ºç«‹æ€§èƒ½ç›‘æ§å’Œè´¨é‡ä¿è¯æœºåˆ¶ï¼ŒéªŒè¯ç³»ç»Ÿä¼˜åŒ–æ•ˆæœã€‚

### æ ¸å¿ƒä»»åŠ¡

#### T3.1: æ€§èƒ½åŸºå‡†æµ‹è¯•å¥—ä»¶
- **æ–‡ä»¶**: `test/performance/test_token_conversion_benchmarks.ml`
- **è¦†ç›–èŒƒå›´**:
  - Tokenè½¬æ¢æ€§èƒ½æµ‹è¯•
  - å†…å­˜ä½¿ç”¨ç›‘æ§
  - å¹¶å‘å¤„ç†æ€§èƒ½æµ‹è¯•
- **æµ‹è¯•ç±»å‹**: æ€§èƒ½æµ‹è¯•

#### T3.2: å›å½’æµ‹è¯•è‡ªåŠ¨åŒ–
- **æ–‡ä»¶**: `test/regression/test_token_system_regression.ml`
- **è¦†ç›–èŒƒå›´**:
  - å†å²åŠŸèƒ½ä¿æŒéªŒè¯
  - æ€§èƒ½å›é€€æ£€æµ‹
  - å…¼å®¹æ€§å›å½’æ£€æŸ¥
- **æµ‹è¯•ç±»å‹**: å›å½’æµ‹è¯•

#### T3.3: è´¨é‡é—¨ç¦è®¾ç½®
- **CIé…ç½®**: è®¾ç½®æµ‹è¯•é€šè¿‡é—¨ç¦
- **è¦†ç›–ç‡é—¨ç¦**: å¼ºåˆ¶è¦†ç›–ç‡è¦æ±‚
- **æ€§èƒ½é—¨ç¦**: æ€§èƒ½åŸºå‡†æ£€æŸ¥

### éªŒæ”¶æ ‡å‡†
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•å»ºç«‹å¹¶é€šè¿‡
- [ ] å›å½’æµ‹è¯•å¥—ä»¶è¦†ç›–å…³é”®åŠŸèƒ½
- [ ] è´¨é‡é—¨ç¦åœ¨CIä¸­ç”Ÿæ•ˆ

## ğŸ”§ æµ‹è¯•å·¥å…·å’ŒåŸºç¡€è®¾æ–½

### æµ‹è¯•æ¡†æ¶
- **å•å…ƒæµ‹è¯•**: OUnit2
- **æ€§èƒ½æµ‹è¯•**: OCaml Benchmark
- **è¦†ç›–ç‡**: Bisect_ppx
- **CIé›†æˆ**: Dune + GitHub Actions

### æµ‹è¯•æ•°æ®ç®¡ç†
- **æµ‹è¯•æ•°æ®**: æ ‡å‡†åŒ–æµ‹è¯•ç”¨ä¾‹é›†
- **Mockæ•°æ®**: æ¨¡æ‹ŸTokenæµæ•°æ®
- **åŸºå‡†æ•°æ®**: æ€§èƒ½åŸºçº¿æ•°æ®é›†

### æµ‹è¯•è¾…åŠ©å·¥å…·
```ocaml
(* æµ‹è¯•å·¥å…·æ¨¡å— *)
module Test_utils = struct
  val generate_test_tokens : int -> Token_types.token list
  val compare_token_streams : Token_types.token_stream -> Token_types.token_stream -> bool
  val measure_conversion_time : ('a -> 'b) -> 'a -> float * 'b
end
```

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡ç›‘æ§

### è¦†ç›–ç‡ç›®æ ‡
| æ¨¡å— | ç›®æ ‡è¦†ç›–ç‡ | å½“å‰çŠ¶æ€ | è¡ŒåŠ¨è®¡åˆ’ |
|------|------------|----------|----------|
| legacy_type_bridge.ml | 95% | 0% | Phase T1 |
| token_types.ml | 90% | ä¼°è®¡30% | Phase T2 |
| Tokenç³»ç»Ÿæ•´ä½“ | 90% | ä¼°è®¡40% | Phase T1-T3 |

### ç›‘æ§æœºåˆ¶
- **æ¯æ—¥æŠ¥å‘Š**: CIç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
- **è¶‹åŠ¿ç›‘æ§**: è¦†ç›–ç‡å˜åŒ–è¶‹åŠ¿è·Ÿè¸ª
- **è´¨é‡ä»ªè¡¨æ¿**: æµ‹è¯•è´¨é‡å¯è§†åŒ–

## ğŸš¨ é£é™©ç¼“è§£ç­–ç•¥

### æŠ€æœ¯é£é™©
1. **æµ‹è¯•å¤æ‚åº¦é«˜**: é‡‡ç”¨åˆ†å±‚æµ‹è¯•ï¼Œé™ä½å•ä¸ªæµ‹è¯•å¤æ‚åº¦
2. **æ€§èƒ½æµ‹è¯•ä¸ç¨³å®š**: å»ºç«‹ç¨³å®šçš„åŸºå‡†ç¯å¢ƒå’Œå¤šæ¬¡æµ‹é‡
3. **å…¼å®¹æ€§æµ‹è¯•å…¨é¢æ€§**: åˆ›å»ºè‡ªåŠ¨åŒ–å…¼å®¹æ€§éªŒè¯å·¥å…·

### æ—¶é—´é£é™©
1. **æµ‹è¯•å¼€å‘æ—¶é—´**: å¹¶è¡Œå¼€å‘æµ‹è¯•å’ŒåŠŸèƒ½ä»£ç 
2. **CIè¿è¡Œæ—¶é—´**: ä¼˜åŒ–æµ‹è¯•æ‰§è¡Œæ—¶é—´ï¼Œä½¿ç”¨å¹¶è¡Œæµ‹è¯•
3. **ç»´æŠ¤æˆæœ¬**: å»ºç«‹å¯ç»´æŠ¤çš„æµ‹è¯•æ¶æ„

## ğŸ“‹ äº¤ä»˜ç‰©æ¸…å•

### Phase T1 äº¤ä»˜ç‰©
- [ ] `test/unit/test_legacy_type_bridge_comprehensive.ml`
- [ ] `test/integration/test_token_compatibility_integration.ml`
- [ ] æµ‹è¯•CIé…ç½®æ›´æ–°
- [ ] æµ‹è¯•è¦†ç›–ç‡åŸºçº¿æŠ¥å‘Š

### Phase T2 äº¤ä»˜ç‰©
- [ ] `test/integration/test_unified_token_system.ml`
- [ ] `test/unit/test_token_utilities_comprehensive.ml`
- [ ] `test/unit/test_token_error_handling.ml`
- [ ] Tokenç³»ç»Ÿæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š

### Phase T3 äº¤ä»˜ç‰©
- [ ] `test/performance/test_token_conversion_benchmarks.ml`
- [ ] `test/regression/test_token_system_regression.ml`
- [ ] è´¨é‡é—¨ç¦é…ç½®
- [ ] æ€§èƒ½åŸºå‡†åŸºçº¿æ•°æ®

## ğŸ¯ æˆåŠŸæ ‡å‡†

### åŠŸèƒ½è´¨é‡
- [ ] æ‰€æœ‰æ–°å¢Tokenç³»ç»ŸåŠŸèƒ½ç»è¿‡æµ‹è¯•éªŒè¯
- [ ] å…¼å®¹æ€§è½¬æ¢å‡½æ•°100%æµ‹è¯•è¦†ç›–
- [ ] é›¶å›å½’ç¼ºé™·åœ¨æµ‹è¯•ä¸­å‘ç°

### æ€§èƒ½è´¨é‡
- [ ] æ€§èƒ½ä¼˜åŒ–å£°æ˜é€šè¿‡åŸºå‡†æµ‹è¯•éªŒè¯
- [ ] å†…å­˜ä½¿ç”¨åœ¨é¢„æœŸèŒƒå›´å†…
- [ ] å¹¶å‘æ€§èƒ½æ»¡è¶³è¦æ±‚

### è¿‡ç¨‹è´¨é‡
- [ ] æµ‹è¯•ä¼˜å…ˆçš„å¼€å‘æµç¨‹å»ºç«‹
- [ ] è‡ªåŠ¨åŒ–æµ‹è¯•åœ¨CIä¸­ç¨³å®šè¿è¡Œ
- [ ] æµ‹è¯•ç»´æŠ¤æˆæœ¬åœ¨å¯æ¥å—èŒƒå›´

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å…¼å®¹æ€§æµ‹è¯•ç­–ç•¥](./0002-compatibility-test-strategy.md)
- [æ€§èƒ½åŸºå‡†æµ‹è¯•è®¡åˆ’](./0003-performance-benchmark-plan.md)
- [æµ‹è¯•å·¥å…·ä½¿ç”¨æŒ‡å—](./0004-test-tools-guide.md)

---

**çŠ¶æ€**: è§„åˆ’ä¸­  
**ä¸‹ä¸€æ­¥**: å¼€å§‹Phase T1çš„å®æ–½

Author: Echo, æµ‹è¯•å·¥ç¨‹å¸ˆ

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>