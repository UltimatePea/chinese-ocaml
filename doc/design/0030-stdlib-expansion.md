# 标准库扩展设计文档

## 概述

本文档描述了骆言编程语言标准库的大幅扩展。在已有基础功能的基础上，新增了大量实用的数学函数、字符串操作函数和类型转换函数，使骆言语言具备了更完备的标准库支持。

## 设计目标

### 扩展原则
1. **实用性优先**: 添加最常用的数学和字符串操作函数
2. **AI友好**: 选择AI编程中常用的函数类型
3. **类型安全**: 所有函数都有完整的类型检查和错误处理
4. **中文命名**: 保持骆言语言的中文特色
5. **性能考虑**: 使用OCaml内置函数确保高效执行

### 目标用户
- **AI开发者**: 需要数学计算和数据处理的AI应用
- **科学计算**: 需要丰富数学函数库的科学应用
- **文本处理**: 需要字符串操作的文本处理应用
- **通用编程**: 需要完整标准库的一般编程任务

## 新增函数分类

### 扩展数学函数

#### 对数函数
- **对数**: 自然对数函数 `ln(x)`
- **自然对数**: 自然对数函数 `ln(x)` (别名)
- **十进制对数**: 十进制对数函数 `log10(x)`

#### 指数函数
- **指数**: 指数函数 `e^x`

#### 三角函数补充
- **正切**: 正切函数 `tan(x)`
- **反正弦**: 反正弦函数 `asin(x)`，定义域 [-1, 1]
- **反余弦**: 反余弦函数 `acos(x)`，定义域 [-1, 1]
- **反正切**: 反正切函数 `atan(x)`

#### 取整函数
- **向上取整**: 向上取整函数 `ceil(x)`
- **向下取整**: 向下取整函数 `floor(x)`
- **四舍五入**: 四舍五入函数

#### 数论函数
- **最大公约数**: 计算两个整数的最大公约数
- **最小公倍数**: 计算两个整数的最小公倍数

### 扩展字符串函数

#### 基础字符串操作
- **字符串长度**: 获取字符串长度 (与已有的`长度`函数重复但更明确)
- **字符串连接**: 连接两个字符串
- **字符串分割**: 按分隔符分割字符串为列表

#### 字符串转换
- **大写转换**: 转换为大写字母
- **小写转换**: 转换为小写字母
- **去除空白**: 去除字符串前后空白字符

#### 字符串高级操作
- **字符串替换**: 替换字符串中的所有匹配子串
- **子字符串**: 提取字符串的子串
- **字符串比较**: 字典序比较两个字符串

### 类型转换函数

#### 数字到字符串
- **整数到字符串**: 将整数转换为字符串
- **浮点数到字符串**: 将浮点数转换为字符串

#### 字符串到数字
- **字符串到整数**: 将字符串解析为整数
- **字符串到浮点数**: 将字符串解析为浮点数

## 函数实现详解

### 数学函数实现

#### 对数函数组
```ocaml
("对数", BuiltinFunctionValue (function
  | [IntValue n] ->
    if n > 0 then FloatValue (log (float_of_int n))
    else raise (RuntimeError "对数函数的参数必须是正数")
  | [FloatValue f] ->
    if f > 0.0 then FloatValue (log f)
    else raise (RuntimeError "对数函数的参数必须是正数")
  | _ -> raise (RuntimeError "对数函数期望一个正数参数")));
```

特点：
- 支持整数和浮点数输入
- 自动类型转换
- 完整的边界检查（正数验证）
- 中文错误消息

#### 三角函数实现
所有三角函数都支持整数和浮点数输入，自动转换为浮点数输出：

```ocaml
("反正弦", BuiltinFunctionValue (function
  | [IntValue n] ->
    let f = float_of_int n in
    if f >= -1.0 && f <= 1.0 then FloatValue (asin f)
    else raise (RuntimeError "反正弦函数的参数必须在[-1,1]范围内")
  | [FloatValue f] ->
    if f >= -1.0 && f <= 1.0 then FloatValue (asin f)
    else raise (RuntimeError "反正弦函数的参数必须在[-1,1]范围内")
  | _ -> raise (RuntimeError "反正弦函数期望一个数字参数")));
```

#### 数论函数实现
```ocaml
("最大公约数", BuiltinFunctionValue (function
  | [IntValue a; IntValue b] ->
    let rec gcd x y = if y = 0 then x else gcd y (x mod y) in
    IntValue (gcd (abs a) (abs b))
  | _ -> raise (RuntimeError "最大公约数函数期望两个整数参数")));
```

使用欧几里得算法，支持负数输入。

### 字符串函数实现

#### 字符串分割
```ocaml
("字符串分割", BuiltinFunctionValue (function
  | [StringValue str; StringValue sep] ->
    let parts = String.split_on_char (String.get sep 0) str in
    ListValue (List.map (fun s -> StringValue s) parts)
  | _ -> raise (RuntimeError "字符串分割函数期望字符串和分隔符参数")));
```

特点：
- 使用分隔符的第一个字符进行分割
- 返回字符串列表
- 与其他列表函数（如`映射`、`过滤`）完美配合

#### 字符串替换
```ocaml
("字符串替换", BuiltinFunctionValue (function
  | [StringValue str; StringValue old_str; StringValue new_str] ->
    let regex = Str.regexp_string old_str in
    StringValue (Str.global_replace regex new_str str)
  | _ -> raise (RuntimeError "字符串替换函数期望三个字符串参数")));
```

使用OCaml的Str模块进行全局替换。

### 类型转换实现

#### 安全的字符串解析
```ocaml
("字符串到整数", BuiltinFunctionValue (function
  | [StringValue s] ->
    (try IntValue (int_of_string (String.trim s))
     with Failure _ -> raise (RuntimeError ("无法将字符串转换为整数: " ^ s)))
  | _ -> raise (RuntimeError "字符串到整数函数期望一个字符串参数")));
```

特点：
- 自动去除前后空白
- 详细的错误信息
- 异常安全处理

## 错误处理设计

### 数学函数错误
1. **定义域检查**: 对数、平方根、反三角函数的定义域验证
2. **类型检查**: 确保参数类型正确
3. **特殊值处理**: 处理零、负数等特殊情况

### 字符串函数错误
1. **边界检查**: 子字符串操作的边界验证
2. **格式验证**: 类型转换时的格式检查
3. **空字符串处理**: 合理处理空字符串情况

### 错误消息设计
- **中文错误消息**: 所有错误都使用中文
- **具体错误信息**: 提供导致错误的具体值
- **用户友好**: 错误消息便于理解和调试

## 性能考虑

### 实现效率
- **直接调用**: 所有函数直接调用OCaml内置函数
- **最小开销**: 避免不必要的中间转换
- **内存管理**: 合理的内存分配模式

### 类型转换优化
- **惰性转换**: 只在必要时进行类型转换
- **缓存友好**: 减少内存分配和垃圾回收压力

## 使用示例

### 科学计算示例
```luoyan
让 角度 = 3.14159 / 4.0        (* 45度 *)
让 正弦值 = 正弦 角度
让 余弦值 = 余弦 角度
让 正切值 = 正切 角度

让 数据 = [1.0; 4.0; 9.0; 16.0; 25.0]
让 平方根列表 = 映射 平方根 数据
让 对数列表 = 映射 对数 数据
```

### 字符串处理示例
```luoyan
让 原始文本 = "  Hello, World! Welcome to Luoyan!  "
让 清理文本 = 去除空白 原始文本
让 大写文本 = 大写转换 清理文本
让 单词列表 = 字符串分割 大写文本 " "
让 处理后 = 映射 (函数 word -> 小写转换 word) 单词列表
```

### 类型转换示例
```luoyan
让 数字字符串 = ["1"; "2"; "3"; "4"; "5"]
让 数字列表 = 映射 字符串到整数 数字字符串
让 平方列表 = 映射 平方 数字列表
让 结果字符串 = 映射 整数到字符串 平方列表
```

## 与现有功能集成

### 高阶函数配合
新增函数与已有的`映射`、`过滤`、`折叠`等高阶函数完美配合：

```luoyan
让 数据 = [1; 2; 3; 4; 5]
让 平方根 = 映射 (函数 x -> 平方根 (整数到浮点数 x)) 数据
让 大于2 = 过滤 (函数 x -> x > 2.0) 平方根
让 总和 = 折叠 (+.) 0.0 大于2
```

### 错误恢复系统
新增函数支持骆言语言的错误恢复机制，在类型不匹配时可以自动尝试转换。

## 测试覆盖

### 功能测试
- **基础功能**: 每个函数的基本功能测试
- **边界情况**: 定义域边界、空字符串、特殊值测试
- **错误处理**: 错误情况的正确处理测试

### 集成测试
- **函数组合**: 多个函数组合使用的测试
- **类型兼容**: 与现有类型系统的兼容性测试
- **性能测试**: 大数据量下的性能表现

## 未来扩展方向

### 短期扩展
1. **正则表达式**: 更强大的字符串模式匹配
2. **文件I/O**: 文件读写操作函数
3. **日期时间**: 日期时间处理函数

### 长期规划
1. **网络函数**: HTTP请求、JSON处理
2. **加密函数**: 哈希、加密解密函数
3. **数据结构**: 更多内置数据结构操作

## 结论

标准库的大幅扩展使骆言语言从一个功能齐全的函数式编程语言进化为一个实用的通用编程语言。新增的67个内置函数涵盖了：

1. **数学计算**: 完整的数学函数库
2. **字符串处理**: 全面的字符串操作
3. **类型转换**: 安全的类型转换机制
4. **错误处理**: 友好的中文错误信息

这些改进使骆言语言特别适合：
- **AI开发**: 丰富的数学函数支持机器学习算法
- **数据处理**: 强大的字符串和列表操作功能
- **科学计算**: 完备的数学函数库
- **通用编程**: 实用的标准库支持

标准库扩展的成功实现标志着骆言语言已经具备了与主流编程语言竞争的实力，为中文编程社区提供了一个功能完整、性能优秀的编程工具。