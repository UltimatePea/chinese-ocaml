# 异常处理功能设计

## 概述

本文档描述骆言编程语言中异常处理机制的设计。异常处理提供了一种结构化的错误处理方式，使程序能够优雅地处理运行时错误。

## 语法设计

### 异常定义
```
异常 未找到
异常 索引越界 of 整数
异常 文件错误 of 字符串
```

### 抛出异常
```
抛出 未找到
抛出 (索引越界 10)
抛出 (文件错误 "无法打开文件")
```

### 捕获异常
```
尝试
  危险操作 ()
捕获
  | 未找到 -> 打印 "没有找到"
  | 索引越界 n -> 打印 ("索引越界: " ^ 字符串化 n)
  | _ -> 打印 "未知错误"
```

### 带有finally的异常处理
```
尝试
  打开文件 ()
捕获
  | 文件错误 msg -> 打印 msg
最终
  关闭文件 ()
```

## AST 扩展

### 异常相关的表达式
```ocaml
| TryExpr of expr * (pattern * expr) list * expr option
  (* 尝试表达式，异常处理分支，可选的finally块 *)
| RaiseExpr of expr
  (* 抛出异常 *)
```

### 异常相关的语句
```ocaml
| ExceptionDefStmt of identifier * type_expr option
  (* 异常定义语句 *)
```

### 模式匹配扩展
```ocaml
| ExceptionPattern of identifier * pattern option
  (* 异常模式匹配 *)
```

## 关键字

新增关键字：
- `异常` (exception)
- `抛出` (raise)
- `尝试` (try)
- `捕获` (catch/with)
- `最终` (finally)

## 运行时支持

### 异常值
```ocaml
| ExceptionValue of string * runtime_value option
  (* 异常名称和可选的携带值 *)
```

### 异常传播
- 异常在调用栈中向上传播
- 直到被捕获或到达程序顶层
- 未捕获的异常导致程序终止

## 内置异常

1. **断言失败** - 断言条件为假时抛出
2. **匹配失败** - 模式匹配失败时抛出
3. **除零错误** - 除法运算除数为零时抛出
4. **类型错误** - 运行时类型不匹配时抛出

## 实现步骤

1. **词法分析器**
   - 添加异常相关关键字
   - 更新关键字映射表

2. **AST 定义**
   - 添加异常相关的表达式和语句类型
   - 扩展模式匹配

3. **语法分析器**
   - 解析异常定义语句
   - 解析try-catch-finally结构
   - 解析raise表达式

4. **代码生成器**
   - 实现异常值类型
   - 实现异常抛出和捕获逻辑
   - 管理异常传播

5. **类型系统**
   - 异常类型推断
   - 确保异常处理的类型安全

## 示例程序

### 基本异常处理
```
异常 无效参数 of 字符串

让 检查年龄 = 函数 年龄 ->
  如果 年龄 < 0 那么
    抛出 (无效参数 "年龄不能为负数")
  否则如果 年龄 > 150 那么
    抛出 (无效参数 "年龄不能超过150")
  否则
    打印 ("年龄: " ^ 字符串化 年龄)

尝试
  检查年龄 (-5)
捕获
  | 无效参数 msg -> 打印 ("错误: " ^ msg)
```

### 资源管理
```
异常 文件未找到

让 读取文件 = 函数 文件名 ->
  如果 不存在 文件名 那么
    抛出 文件未找到
  否则
    读取内容 文件名

让 处理文件 = 函数 文件名 ->
  让 文件句柄 = 引用 空 在
  尝试
    文件句柄 := 打开文件 文件名;
    处理内容 (!文件句柄)
  捕获
    | 文件未找到 -> 打印 "文件不存在"
    | e -> 抛出 e  (* 重新抛出其他异常 *)
  最终
    如果 !文件句柄 <> 空 那么
      关闭文件 (!文件句柄)
```

## AI友好性考虑

1. **明确的错误信息** - 异常应携带详细的错误描述
2. **结构化错误处理** - 避免使用返回码的错误处理方式
3. **资源安全** - finally块确保资源正确释放
4. **类型安全** - 编译时检查异常处理的完整性

## 与错误恢复系统的关系

异常处理系统与现有的错误恢复系统互补：
- 错误恢复系统：处理类型错误等可恢复的错误
- 异常处理系统：处理业务逻辑错误和不可恢复的错误

两个系统可以协同工作，提供全面的错误处理能力。