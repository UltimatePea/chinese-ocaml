# 移除OOP功能并引入OCaml风格模块系统设计方案

## 背景

根据项目维护者@UltimatePea的要求（GitHub问题#70），需要完全移除当前的面向对象编程（OOP）功能，转而采用类似OCaml的模块系统。这是一个重大的架构调整，将影响编译器的各个组件。

## 当前OOP功能分析

### 核心OOP组件
1. **AST节点**：`ClassDefExpr`, `NewObjectExpr`, `MethodCallExpr`, `SelfExpr`, `ClassDefStmt`
2. **类型系统**：`ClassType`, `ObjectType`, `class_def`, `method_def`
3. **词法分析器**：类相关关键字（类、继承、方法、新建、自己、私有、虚拟）
4. **语法分析器**：类定义、对象创建、方法调用解析
5. **语义分析**：类型推断、方法调用检查
6. **代码生成**：对象创建、方法调用执行
7. **C后端**：OOP运行时支持

## 新模块系统设计

### 模块系统特性
参考OCaml的模块系统设计，支持以下功能：
1. **模块定义**：`模块 名称 乃 ... 毕`
2. **模块类型签名**：`模块类型 名称 乃 ... 毕`
3. **模块引用**：`模块名.函数名`
4. **模块包含**：`包含 模块名`
5. **函子（Functor）**：参数化模块

### 新关键字设计
- `模块` (Module) - 替代 `类`
- `模块类型` (ModuleType) - 模块类型签名
- `包含` (Include) - 替代 `继承`
- `签名` (Signature) - 模块接口
- `实现` (Implementation) - 模块实现
- `函子` (Functor) - 参数化模块

## 实施计划

### 第一阶段：AST和类型系统重构
1. 移除OOP相关AST节点
2. 添加模块相关AST节点：
   - `ModuleDefExpr` - 模块定义
   - `ModuleTypeExpr` - 模块类型
   - `ModuleAccessExpr` - 模块成员访问
   - `IncludeExpr` - 模块包含
   - `FunctorExpr` - 函子定义

### 第二阶段：词法和语法分析重构
1. 移除OOP关键字
2. 添加模块系统关键字
3. 重写解析规则

### 第三阶段：语义分析重构
1. 实现模块类型检查
2. 模块作用域管理
3. 模块成员解析

### 第四阶段：代码生成重构
1. 移除OOP运行时
2. 实现模块编译
3. 更新C后端支持

### 第五阶段：测试和示例更新
1. 重写所有测试用例
2. 创建模块系统示例
3. 更新文档

## 模块语法示例

### 模块定义
```
模块「数学工具」乃
  设「圆周率」为 3.14159;
  
  夫「面积」者受「半径」焉算法乃
    答「圆周率」乘「半径」乘「半径」是谓。
  毕
毕
```

### 模块类型签名
```
模块类型「数学接口」乃
  值「圆周率」：实数;
  夫「面积」：实数 -> 实数;
毕
```

### 模块使用
```
设「圆面积」为「数学工具.面积 5.0」;
```

## 兼容性考虑

这是一个破坏性变更，所有现有的OOP代码都需要重写为模块形式。为了平滑过渡：

1. 保留旧文档作为参考
2. 提供迁移指南
3. 创建示例对比新旧语法

## 预期收益

1. **简化设计**：移除复杂的OOP继承机制
2. **类型安全**：OCaml风格的静态类型检查
3. **模块化**：更好的代码组织和重用
4. **AI友好**：更清晰的语法结构便于AI理解和生成

## 实施时间线

- 第一阶段：1-2天
- 第二阶段：1天
- 第三阶段：2-3天
- 第四阶段：2-3天
- 第五阶段：1-2天

总预计时间：7-11天

## 风险评估

- **高风险**：大规模重构可能引入新bug
- **中风险**：现有功能暂时不可用
- **低风险**：文档同步滞后

## 缓解措施

1. 分阶段实施，每阶段后运行基础测试
2. 保留git历史记录便于回滚
3. 优先实现核心功能，再完善细节

## 结论

移除OOP并引入模块系统是一个重大但有益的重构。这将使骆言编程语言更加简洁、类型安全，并且更符合函数式编程范式。