# 古雅体记录语法设计方案

## 问题概述

目前骆言语言使用现代西式的记录语法 `{ x = ...; y = ... }`，需要设计一套符合古雅体文言风格的替代方案，与已实现的古雅体列表语法保持一致的设计理念。

## 设计原则

1. **文言风格**：使用传统中文表达方式，避免西式标点符号
2. **语义清晰**：每个部分都有明确的语义标识
3. **易于解析**：便于词法分析和语法解析
4. **一致性**：与现有古雅体列表语法风格保持一致

## 古雅体记录语法方案

### 1. 基本记录创建语法

现代语法：
```ocaml
{ 姓名 = "张三"; 年龄 = 20; 成绩 = 95.5 }
```

古雅体语法：
```ocaml
据开始 姓名为『张三』其一 年龄为20其二 成绩为95.5其三 据结束
```

### 2. 空记录语法

现代语法：
```ocaml
{}
```

古雅体语法：
```ocaml
据空
```

### 3. 记录更新语法

现代语法：
```ocaml
{ 学生1 与 年龄 = 19; 成绩 = 92.0 }
```

古雅体语法：
```ocaml
据更新 学生1 年龄为19其一 成绩为92.0其二 据毕
```

### 4. 字段访问语法

现代语法：
```ocaml
学生.姓名
```

古雅体语法（保持不变，符合传统）：
```ocaml
学生.姓名
```

## 语法结构分析

### 1. 关键词定义

- `据开始` - 开始记录定义
- `据结束` - 结束记录定义
- `据空` - 空记录
- `据更新` - 记录更新开始
- `据毕` - 记录更新结束
- `为` - 字段赋值连接词
- `其一`、`其二`、`其三` - 字段序号（与列表语法一致）

### 2. 语法模式

#### 记录创建模式：
```
据开始 <字段名>为<值><序号> [<字段名>为<值><序号>]* 据结束
```

#### 记录更新模式：
```
据更新 <记录表达式> <字段名>为<值><序号> [<字段名>为<值><序号>]* 据毕
```

### 3. 序号规则

与古雅体列表语法保持一致：
- 第1个字段：`其一`
- 第2个字段：`其二`
- 第3个字段：`其三`
- 第4个及以后：`其一`（循环使用）

## 实现计划

### 阶段1：词法分析器扩展
1. 添加新的关键词token：
   - `RecordStartKeyword` ("据开始")
   - `RecordEndKeyword` ("据结束")
   - `RecordEmptyKeyword` ("据空")
   - `RecordUpdateKeyword` ("据更新")
   - `RecordFinishKeyword` ("据毕")
   - `FieldAssignKeyword` ("为")

### 阶段2：语法分析器修改
1. 修改 `parse_record_expression` 函数
2. 添加 `parse_ancient_record_expression` 函数
3. 添加 `parse_ancient_record_update` 函数
4. 禁用现代记录语法 `{}`，提供迁移提示

### 阶段3：AST节点扩展
现有AST节点可以复用：
- `RecordExpr` - 记录表达式
- `RecordUpdateExpr` - 记录更新表达式

### 阶段4：迁移脚本开发
创建自动迁移脚本：
1. 识别现代记录语法模式
2. 转换为古雅体语法
3. 处理嵌套记录结构

## 示例对比

### 简单记录
```ocaml
// 现代语法
设「学生」为{ 姓名=『张三』; 年龄=20; 成绩=95.5 }

// 古雅体语法
设「学生」为(据开始 姓名为『张三』其一 年龄为20其二 成绩为95.5其三 据结束)
```

### 记录更新
```ocaml
// 现代语法
设「学生2」为{ 学生1 与 年龄=19; 成绩=92.0 }

// 古雅体语法
设「学生2」为(据更新 学生1 年龄为19其一 成绩为92.0其二 据毕)
```

### 嵌套记录
```ocaml
// 现代语法
设「班级」为{
  名称=『一年级甲班』;
  班主任={ 姓名=『李老师』; 年龄=35 };
  学生数=30
}

// 古雅体语法
设「班级」为(据开始
  名称为『一年级甲班』其一
  班主任为(据开始 姓名为『李老师』其一 年龄为35其二 据结束)其二
  学生数为30其三
据结束)
```

## 优势分析

1. **文化一致性**：与古雅体列表语法保持风格统一
2. **语义明确**：每个组成部分都有清晰的语义标识
3. **可读性强**：符合中文表达习惯，易于理解
4. **扩展性好**：可以方便地添加新的记录操作语法

## 向后兼容性

1. 实现阶段将先禁用现代语法，提供清晰的错误信息
2. 提供自动迁移脚本帮助用户转换现有代码
3. 保持字段访问语法不变，降低迁移成本

## 总结

古雅体记录语法设计在保持语义清晰的同时，实现了与传统中文表达方式的深度融合，为骆言语言的古雅体语法体系奠定了坚实基础。