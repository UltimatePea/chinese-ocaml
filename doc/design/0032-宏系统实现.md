# 宏系统实现设计文档

## 文档信息
- **文档编号**: 0015
- **创建日期**: 2025-07-12
- **版本**: 1.0
- **作者**: Claude Code Agent

## 概述

本文档描述了骆言编程语言宏系统的设计和实现。宏系统是一个代码生成和元编程工具，允许程序员编写能够生成其他代码的代码。

## 设计目标

### 核心目标
1. **简单易用**: 提供直观的中文语法进行宏定义和调用
2. **类型安全**: 在编译时进行基本的类型检查
3. **性能高效**: 宏展开在编译期完成，运行时零开销
4. **AI友好**: 易于AI理解和使用的宏系统

### 功能特性
- 宏定义支持多种参数类型（表达式、语句、类型）
- 简单的宏展开机制
- 与现有语言特性的良好集成
- 在词法、语法、语义分析和代码生成阶段的完整支持

## 语法设计

### 宏定义语法
```
宏 <宏名> (<参数列表>) = <宏体>
```

### 参数类型
- `参数名: 表达式` - 表达式参数
- `参数名: 语句` - 语句参数
- `参数名: 类型` - 类型参数

### 宏调用语法
```
<宏名> <参数1> <参数2> ...
```

## 技术实现

### 1. 词法分析扩展

#### 新增关键字
- `宏` (MacroKeyword) - 宏定义关键字
- `展开` (ExpandKeyword) - 宏展开关键字（预留）

#### 词法分析器修改
```ocaml
(* 新增宏系统关键字 *)
| MacroKeyword                (* 宏 - macro *)
| ExpandKeyword               (* 展开 - expand *)

(* 关键字映射表添加 *)
("宏", MacroKeyword);
("展开", ExpandKeyword);
```

### 2. 语法分析扩展

#### AST新增节点
```ocaml
(* 宏参数类型 *)
type macro_param =
  | ExprParam of identifier    (* 表达式参数 *)
  | StmtParam of identifier    (* 语句参数 *)
  | TypeParam of identifier    (* 类型参数 *)

(* 宏定义 *)
type macro_def = {
  macro_def_name: macro_name;
  params: macro_param list;
  body: expr;
}

(* 宏调用 *)
type macro_call = {
  macro_call_name: macro_name;
  args: expr list;
}
```

#### 解析器功能
- `parse_macro_params`: 解析宏参数列表
- 在 `parse_statement` 中添加 `MacroKeyword` 分支
- 宏调用通过现有函数调用语法解析

### 3. 语义分析扩展

#### 上下文扩展
```ocaml
type semantic_context = {
  (* 现有字段 *)
  scope_stack: scope_stack;
  current_function_return_type: typ option;
  error_list: string list;
  (* 新增宏环境 *)
  macros: (string * macro_def) list;
}
```

#### 分析功能
- 宏定义时：将宏添加到上下文的宏环境中
- 宏调用时：检查宏是否已定义，进行基本验证

### 4. 代码生成扩展

#### 宏环境管理
```ocaml
(* 全局宏表 *)
let macro_table: (string, macro_def) Hashtbl.t = Hashtbl.create 16

(* 简单的宏展开 *)
let expand_macro macro_def _args =
  (* 简化版本：直接返回宏体 *)
  macro_def.body
```

#### 执行机制
- `MacroDefStmt`: 将宏定义保存到全局宏表
- `MacroCallExpr`: 查找宏定义，展开并递归求值

### 5. C代码生成支持

当前C代码生成器中宏调用返回占位符代码：
```c
/* 宏调用尚未在C代码生成中实现 */ 0
```

## 实现状态

### ✅ 已完成功能
1. **词法分析**: 宏关键字识别
2. **语法分析**: 宏定义和调用解析
3. **语义分析**: 宏环境管理和基本检查
4. **代码生成**: 基本宏展开和执行
5. **字符串连接**: 新增 `^` 运算符支持

### 🔄 待完善功能
1. **完整宏展开**: 参数替换机制
2. **宏调用集成**: 与函数调用语法的更好集成
3. **C代码生成**: 宏在C后端的完整支持
4. **错误处理**: 更详细的宏相关错误信息
5. **测试用例**: 完整的宏系统测试套件

## 示例程序

### 基本宏定义
```luoyan
(* 宏系统测试程序 *)

宏 简单测试 (x: 表达式) = 打印 x

简单测试 "这是一个简单的宏测试"
```

### 当前限制
- 宏调用语法仍需完善
- 参数替换机制尚未实现
- 复杂宏展开暂不支持

## 测试验证

### 基本功能测试
- ✅ 宏定义解析正常
- ✅ 不影响现有功能（所有测试通过）
- ⚠️ 宏调用需要语法改进

### 集成测试
所有现有测试套件（100+测试）均通过，确保宏系统添加不影响现有功能。

## 未来发展

### 短期目标
1. 完善宏调用语法
2. 实现参数替换机制
3. 添加宏系统测试用例

### 长期目标
1. 高级宏特性（条件宏、递归宏）
2. 编译时计算
3. 代码生成优化

## 技术依赖

### 现有模块依赖
- `Ast`: AST节点定义
- `Lexer`: 词法分析
- `Parser`: 语法分析
- `Semantic`: 语义分析
- `Types`: 类型系统
- `Codegen`: 代码生成

### 新增依赖
- 无外部依赖
- 扩展现有模块功能

## 结论

宏系统的基础实现已完成，提供了宏定义、解析、语义分析和基本展开功能。虽然还需要进一步完善，但已建立了坚实的基础架构，为未来的功能扩展做好了准备。

当前实现遵循了AI友好的设计原则，使用简洁的中文语法，便于AI理解和使用。下一步的重点是完善宏调用机制和参数处理，使宏系统达到实用水平。