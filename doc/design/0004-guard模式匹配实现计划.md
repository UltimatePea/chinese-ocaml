# Guard模式匹配实现计划

## 当前状态

已开始实现OCaml风格的guard模式匹配功能（`pattern 当 condition -> expr`）。

### 已完成 ✅
1. **AST扩展**: 添加 `match_branch` 类型支持guard条件
2. **解析器更新**: 支持解析 `当` (when) 关键字和guard表达式
3. **代码生成部分更新**: `execute_match` 和 `execute_exception_match` 支持guard评估
4. **类型推断部分更新**: 在 `types.ml` 中支持guard类型检查

### 待完成 ❌
1. **semantic.ml更新**: 语义分析器适配新的match_branch结构
2. **c_codegen.ml更新**: C后端代码生成器适配
3. **测试用例**: 创建guard模式匹配的测试

## 技术细节

### AST变更
```ocaml
(* 之前 *)
MatchExpr of expr * (pattern * expr) list

(* 现在 *)
MatchExpr of expr * match_branch list

type match_branch = {
  pattern: pattern;
  guard: expr option;    (* guard条件: 当 condition *)
  expr: expr;           (* 分支表达式 *)
}
```

### 语法示例
```
匹配 x 与
| n 当 n > 0 -> "正数"
| 0 -> "零"
| _ -> "负数"
```

### 实现挑战

1. **向后兼容性**: 必须确保现有代码仍然有效
2. **类型安全**: Guard表达式必须返回布尔值
3. **性能**: Guard条件的求值不应影响模式匹配性能
4. **错误处理**: 提供清晰的guard失败错误信息

## 完成策略

### 步骤1: 完成核心文件更新
- [ ] 更新 `semantic.ml` 
- [ ] 更新 `c_codegen.ml`
- [ ] 确保所有编译错误解决

### 步骤2: 添加测试
- [ ] 基础guard模式匹配测试
- [ ] 复杂guard条件测试
- [ ] 错误处理测试
- [ ] 性能边界测试

### 步骤3: 文档和示例
- [ ] 更新语法文档
- [ ] 创建guard模式匹配示例程序
- [ ] 更新用户指南

### 步骤4: 集成和验证
- [ ] 运行完整测试套件
- [ ] 验证向后兼容性
- [ ] 性能回归测试

## 时间估算

- 核心实现完成: 1-2小时
- 测试和验证: 1小时  
- 文档和示例: 30分钟
- **总计**: 2.5-3.5小时

## 风险和缓解

### 风险1: 破坏现有功能
**缓解**: 在每个步骤后运行完整测试套件

### 风险2: 性能回归
**缓解**: 创建性能基准测试

### 风险3: 复杂性增加
**缓解**: 提供清晰的使用文档和示例

## 下一步行动

1. 暂停当前实现，提交部分进度
2. 创建issue跟踪完整实现
3. 制定详细的完成时间表
4. 在下次会话中继续完成

这个功能将显著增强骆言编程语言的表达能力，使其更接近OCaml的功能完整性。