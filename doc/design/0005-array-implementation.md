# 数组功能实现设计

## 概述

本文档描述骆言编程语言中数组功能的实现设计。数组是一种可变的、固定大小的数据结构，提供高效的随机访问。

## 语法设计

### 数组字面量
```
让 数组 = [|1; 2; 3; 4; 5|]
```

### 数组访问
```
让 第一个 = 数组.(0)
让 最后一个 = 数组.(长度 数组 - 1)
```

### 数组更新
```
数组.(0) <- 10
```

### 数组创建函数
```
让 空数组 = 创建数组 10 0       (* 创建长度为10，初始值为0的数组 *)
让 初始化数组 = 初始化数组 5 (函数 i -> i * 2)  (* [|0; 2; 4; 6; 8|] *)
```

### 数组操作
```
让 长度值 = 数组长度 数组
让 复制 = 复制数组 数组
让 子数组 = 子数组 数组 1 3     (* 从索引1开始，长度为3 *)
```

## AST 扩展

### 表达式类型
```ocaml
| ArrayExpr of expr list              (* [|expr1; expr2; ...|] *)
| ArrayAccessExpr of expr * expr      (* array.(index) *)
| ArrayUpdateExpr of expr * expr * expr  (* array.(index) <- value *)
```

### 语句类型
```ocaml
| ArrayUpdateStmt of expr * expr * expr  (* 数组更新语句 *)
```

## 词法分析扩展

需要添加的词元：
- `[|` - 数组开始
- `|]` - 数组结束
- `<-` - 赋值操作符

## 运行时值扩展

```ocaml
| ArrayValue of runtime_value array   (* 可变数组 *)
```

## 内置函数

1. **创建数组** - 创建指定大小和初始值的数组
2. **初始化数组** - 使用函数初始化数组
3. **数组长度** - 获取数组长度
4. **复制数组** - 创建数组的副本
5. **子数组** - 提取数组的一部分

## 实现步骤

1. **词法分析器**
   - 添加 `[|`, `|]`, `<-` 词元
   - 更新词法分析逻辑

2. **AST 定义**
   - 添加数组相关表达式类型
   - 更新 pretty printer

3. **语法分析器**
   - 解析数组字面量 `[| ... |]`
   - 解析数组访问 `expr.(expr)`
   - 解析数组更新 `expr.(expr) <- expr`

4. **代码生成器**
   - 添加 ArrayValue 运行时类型
   - 实现数组创建、访问、更新逻辑
   - 添加边界检查

5. **类型系统**
   - 添加数组类型推断
   - 确保索引是整数类型

6. **测试**
   - 基础功能测试
   - 边界检查测试
   - 性能测试

## 错误处理

1. **索引越界**
   ```
   运行时错误: 数组索引越界: 10 (数组长度: 5)
   ```

2. **类型错误**
   ```
   类型错误: 数组索引必须是整数
   ```

## 与列表的区别

| 特性 | 列表 | 数组 |
|------|------|------|
| 可变性 | 不可变 | 可变 |
| 大小 | 可变 | 固定 |
| 访问复杂度 | O(n) | O(1) |
| 语法 | `[1; 2; 3]` | `[|1; 2; 3|]` |

## 示例程序

```
(* 冒泡排序 *)
让 冒泡排序 = 函数 数组 ->
  让 长度 = 数组长度 数组 在
  让 递归 外循环 = 函数 i ->
    如果 i >= 长度 - 1 那么 ()
    否则
      让 递归 内循环 = 函数 j ->
        如果 j >= 长度 - i - 1 那么 ()
        否则
          如果 数组.(j) > 数组.(j + 1) 那么
            让 临时 = 数组.(j) 在
            数组.(j) <- 数组.(j + 1);
            数组.(j + 1) <- 临时
          否则 ();
          内循环 (j + 1)
      在
      内循环 0;
      外循环 (i + 1)
  在
  外循环 0

让 测试数组 = [|5; 2; 8; 1; 9|]
冒泡排序 测试数组
打印 测试数组  (* [|1; 2; 5; 8; 9|] *)
```