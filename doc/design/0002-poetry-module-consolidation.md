# 诗词模块整合重构设计文档

## 背景
当前 `src/poetry/` 目录存在严重的过度模块化问题，包含140+个独立模块文件，功能重叠严重，维护成本高。

## 现状分析
- 韵律相关模块：26个，功能重复
- 艺术评估模块：9个，职责不清
- 数据加载模块：30+个，接口混乱
- 总计模块数：140+个

## 重构目标
将poetry目录模块数量从140+个减少到15个以内的核心模块。

## 重构阶段

### Phase 1: 核心模块创建
创建统一的核心模块框架：
1. `poetry_rhyme_core.ml` - 韵律核心功能
2. `poetry_rhyme_data.ml` - 韵律数据管理  
3. `poetry_artistic_core.ml` - 艺术评估核心

### Phase 2: 功能迁移
逐步将现有模块功能迁移到核心模块中。

### Phase 3: 依赖更新
更新其他模块对poetry模块的依赖引用。

### Phase 4: 清理旧模块
删除已整合的旧模块文件。

## 实施原则
1. 保持向后兼容性
2. 确保测试通过
3. 保留所有功能，只重组结构
4. 渐进式重构，避免大爆炸式更改

## 当前进度
- [x] 创建设计文档
- [x] Phase 1: 核心模块创建
  - [x] poetry_types_consolidated.ml - 统一类型定义模块
  - [x] poetry_rhyme_core.ml - 韵律核心功能模块
  - [x] poetry_rhyme_data.ml - 韵律数据管理模块
  - [x] poetry_artistic_core.ml - 艺术性评价核心模块
  - [x] 更新dune配置文件以包含新模块
  - [x] 创建测试文件验证新模块功能
- [ ] Phase 2: 功能迁移
  - [ ] 解决模块间依赖和编译问题
  - [ ] 完善接口一致性
  - [ ] 迁移原有模块功能
- [ ] Phase 3: 依赖更新  
- [ ] Phase 4: 清理旧模块

## Phase 1 完成情况总结

成功创建了4个核心整合模块，将原有140+个poetry模块的功能整合到统一的接口中：

### 1. 类型定义整合 (poetry_types_consolidated.ml)
- 整合了rhyme_types.ml和artistic_types.ml的所有类型定义
- 统一了韵律类型、艺术性评价类型、诗词形式类型
- 提供了类型转换和工具函数

### 2. 韵律核心功能整合 (poetry_rhyme_core.ml)  
- 整合了20+个韵律相关模块的核心功能
- 统一了find_rhyme_info等在13+个模块中重复的函数
- 提供完整的韵律检测、分析、验证、评分接口

### 3. 韵律数据管理整合 (poetry_rhyme_data.ml)
- 整合了30+个数据加载和管理模块的功能
- 提供统一的数据访问、缓存、JSON解析接口
- 简化了数据源管理架构

### 4. 艺术性评价整合 (poetry_artistic_core.ml)
- 整合了15+个艺术性评价模块的功能
- 统一了各维度评价函数和专项评价功能
- 提供智能评价助手和传统品评功能

## 技术债务改进效果

1. **模块数量减少**: 从140+个模块减少到4个核心模块
2. **代码重复消除**: 去除了find_rhyme_info等函数的13+个重复实现
3. **接口统一**: 提供了一致的API接口，减少了模块间依赖复杂性
4. **维护性提升**: 集中管理核心功能，便于后续维护和扩展

## 遗留问题

1. **编译问题**: 新模块存在一些语法和类型匹配问题需要修复
2. **向后兼容**: 需要确保原有模块的使用者能够平滑迁移
3. **测试覆盖**: 需要更全面的测试以验证整合后的功能正确性

## 风险评估
- 模块依赖关系复杂，需要仔细处理
- 测试覆盖需要保持
- 可能需要多个小PR而不是一个大PR

## 相关Issue
#1058 - 技术债务改进：诗词模块过度细分整合优化 Phase 5.1