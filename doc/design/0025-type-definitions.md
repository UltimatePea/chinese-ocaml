# 骆言类型定义功能设计文档

## 概述

本文档描述了骆言编程语言中类型定义功能的设计和实现。类型定义允许程序员定义自定义的数据类型，包括类型别名和代数数据类型（变体类型）。

## 功能特性

### 1. 类型别名
允许为现有类型创建别名，提高代码可读性。

```luoyan
类型 整数别名 = 整数
类型 用户编号 = 整数
```

### 2. 代数数据类型（变体类型）
支持定义具有多个构造器的代数数据类型。

```luoyan
类型 选项 =
  | 无
  | 有 of 整数

类型 二叉树 =
  | 空
  | 节点 of 整数 * 二叉树 * 二叉树
```

## 语法设计

### 基本语法
```
类型定义 ::= "类型" 标识符 "=" 类型定义体

类型定义体 ::=
  | 类型表达式                    (* 类型别名 *)
  | 变体构造器列表                 (* 代数数据类型 *)

变体构造器列表 ::=
  | "|" 构造器名
  | "|" 构造器名 "of" 类型表达式
  | 变体构造器列表 "|" 构造器名
  | 变体构造器列表 "|" 构造器名 "of" 类型表达式
```

### 关键字
- `类型` (TypeKeyword) - 定义新类型
- `of` (OfKeyword) - 指定构造器参数类型
- `|` (Pipe) - 分隔变体构造器

## AST 表示

### 类型定义语句
```ocaml
type stmt =
  | ...
  | TypeDefStmt of identifier * type_def

type type_def =
  | AliasType of type_expr              (* 类型别名 *)
  | AlgebraicType of (identifier * type_expr option) list  (* 变体类型 *)
  | RecordType of (identifier * type_expr) list            (* 记录类型 - 未来扩展 *)
```

### 构造器表示
变体类型的构造器表示为 `(构造器名, 可选类型参数)` 的列表：
- `("无", None)` - 无参数构造器
- `("有", Some IntType)` - 带整数参数的构造器

## 实现细节

### 1. 词法分析
- 已支持 `类型` 关键字的识别
- 已支持 `of` 关键字用于构造器参数
- 已支持 `|` 管道符用于分隔构造器

### 2. 语法分析
实现了以下解析函数：
- `parse_type_definition` - 解析类型定义体
- `parse_variant_constructors` - 解析变体构造器列表

### 3. 语句解析
在 `parse_statement` 函数中添加了对 `TypeKeyword` 的支持。

### 4. 代码生成
当前实现中，类型定义在运行时被忽略（返回 `UnitValue`），这是合理的，因为类型定义是编译时的概念。

## 测试覆盖

实现了全面的测试套件：
- 类型别名解析测试
- 简单变体类型测试
- 带参数变体类型测试
- 复杂变体类型测试

所有测试通过，确保功能正确性。

## 示例代码

### 基础用法
```luoyan
类型 选项 = | 无 | 有 of 整数

类型 二叉树 =
  | 空
  | 节点 of 整数 * 二叉树 * 二叉树
```

### 高级用法
```luoyan
类型 表达式 =
  | 常量 of 整数
  | 变量 of 字符串
  | 加法 of 表达式 * 表达式
  | 乘法 of 表达式 * 表达式
```

## 未来扩展

### 1. 构造器表达式支持
需要在表达式解析中添加对构造器的支持，允许创建变体类型的值。

### 2. 模式匹配扩展
扩展模式匹配以支持用户定义的构造器。

### 3. 类型推断集成
将用户定义的类型集成到类型推断系统中。

### 4. 记录类型支持
完整实现记录类型的解析和评估。

## 设计理念

这个实现遵循了以下设计原则：
1. **中文友好** - 使用中文关键字提高 AI 的理解能力
2. **OCaml 兼容** - 语法设计参考 OCaml 的代数数据类型
3. **渐进式实现** - 先实现解析，后续扩展评估和类型检查
4. **测试驱动** - 每个功能都有对应的测试确保质量

## 总结

类型定义功能为骆言编程语言提供了强大的类型系统基础，支持类型别名和代数数据类型。当前实现专注于语法解析，为后续的构造器表达式和模式匹配扩展奠定了基础。